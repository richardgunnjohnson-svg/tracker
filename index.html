<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASX Portfolio</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#6366f1">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #e0f2fe 0%, #ddd6fe 100%);
      min-height: 100vh;
      padding: 16px;
    }
    .container { max-width: 800px; margin: 0 auto; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 { font-size: 24px; color: #1f2937; margin-bottom: 16px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      padding: 8px 16px;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-refresh { background: #6366f1; }
    .btn-sync { background: #10b981; }
    .btn-add { background: #8b5cf6; }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 16px;
    }
    .column {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
    }
    .column-title {
      font-size: 16px;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }
    .metric { margin-bottom: 12px; }
    .metric-label { font-size: 11px; color: #6b7280; margin-bottom: 4px; }
    .metric-value { font-size: 18px; font-weight: bold; color: #1f2937; }
    .metric-value.green { color: #16a34a; }
    .metric-value.red { color: #dc2626; }
    .breakdown {
      margin-left: 12px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
    }
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .breakdown-value { font-weight: 600; color: #1f2937; }
    .breakdown-value.green { color: #16a34a; }
    .breakdown-value.red { color: #dc2626; }
    .breakdown-value.blue { color: #2563eb; }
    
    .stock {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stock-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    .stock-code { font-size: 18px; font-weight: bold; color: #1f2937; }
    .stock-qty { font-size: 13px; color: #6b7280; margin-top: 4px; }
    .stock-price-label { font-size: 11px; color: #6b7280; text-align: right; }
    .stock-price-value { font-size: 14px; font-weight: 600; color: #1f2937; text-align: right; }
    
    .stock-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    .btn-small {
      padding: 4px 12px;
      font-size: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-edit { background: #6366f1; color: white; }
    .btn-delete { background: #dc2626; color: white; }
    
    .status { font-size: 12px; color: #6b7280; margin-top: 8px; }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    .empty-state h2 {
      font-size: 18px;
      margin-bottom: 8px;
      color: #1f2937;
    }
    .empty-state p {
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .dividend-list {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    .dividend-item {
      font-size: 12px;
      color: #6b7280;
      padding: 4px 0;
      display: flex;
      justify-content: space-between;
    }
    .dividend-date { color: #1f2937; font-weight: 600; }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
    }
    .modal-content h2 { margin-bottom: 16px; font-size: 20px; }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    .form-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    .form-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-save { background: #6366f1; color: white; }
    .btn-cancel { background: #e5e7eb; color: #4b5563; }
    
    @media (max-width: 640px) {
      body { padding: 12px; }
      .card { padding: 16px; }
      
      /* Header */
      .header { flex-direction: column; align-items: stretch; gap: 12px; }
      .header h1 { text-align: center; font-size: 22px; }
      .header-buttons { justify-content: center; }
      .btn { 
        padding: 12px 16px; 
        font-size: 13px;
        min-height: 44px; /* iOS touch target minimum */
      }
      .stock-buttons { gap: 6px; }
      .stock-buttons button {
        padding: 8px 12px;
        min-height: 40px;
      }
      
      /* Two-column layout - stack vertically on mobile */
      .two-column {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      /* Columns */
      .column { padding: 12px; }
      .column-title { font-size: 14px; margin-bottom: 10px; }
      
      /* Metrics */
      .metric-label { font-size: 10px; }
      .metric-value { font-size: 16px; }
      .metric-value + div[style*="font-size: 14px"] {
        font-size: 12px !important;
      }
      
      /* Breakdown */
      .breakdown { margin-left: 8px; margin-top: 6px; padding-top: 6px; }
      .breakdown-item { 
        font-size: 11px; 
        margin-top: 3px;
        gap: 8px;
      }
      .breakdown-item span:first-child { max-width: 60%; }
      .breakdown-item > span:last-child {
        text-align: right;
        white-space: nowrap;
      }
      
      /* Ensure percentages don't break awkwardly */
      .breakdown-value {
        display: inline-flex;
        align-items: baseline;
        gap: 3px;
        flex-wrap: wrap;
      }
      
      /* Cost base row on mobile */
      .card > div[style*="background: #f9fafb"] {
        padding: 12px !important;
        margin-bottom: 12px !important;
      }
      .card > div[style*="background: #f9fafb"] span {
        font-size: 12px !important;
      }
      .card > div[style*="background: #f9fafb"] span[style*="font-size: 20px"] {
        font-size: 18px !important;
      }
      .card > div[style*="background: #f9fafb"] span[style*="font-size: 16px"] {
        font-size: 14px !important;
      }
      
      /* Stock cost base */
      .stock > div[style*="background: #f9fafb"] span[style*="font-size: 16px"] {
        font-size: 14px !important;
      }
      
      /* Stock cards */
      .stock { padding: 14px; margin-bottom: 10px; }
      .stock-header { margin-bottom: 12px; padding-bottom: 10px; }
      .stock-code { font-size: 16px; }
      .stock-qty { font-size: 11px; }
      .stock-price-label { font-size: 10px; }
      .stock-price-value { font-size: 14px; }
      
      /* Dividend list */
      .dividend-list { margin-top: 12px; padding-top: 12px; }
      .dividend-item { font-size: 11px; padding: 6px 0; }
      
      /* Status message */
      .status { font-size: 11px; margin-top: 8px; }
      
      /* Modal on mobile */
      .modal-content { 
        width: 95%;
        max-width: 350px;
        padding: 20px;
      }
      .modal-content h2 { font-size: 18px; }
      
      /* Empty state */
      .empty-state { padding: 30px 20px; }
      .empty-state-icon { font-size: 40px; }
      .empty-state-text { font-size: 15px; }
      .empty-state-hint { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1>ASX Portfolio</h1>
        <div class="header-buttons">
          <button class="btn btn-add" onclick="openAddModal()">+ Add</button>
          <button class="btn btn-sync" onclick="syncDividends()" id="syncBtn">⟳ Sync</button>
          <button class="btn btn-refresh" onclick="refresh()" id="refreshBtn">↻ Refresh</button>
        </div>
      </div>
      
      <div id="portfolioSummary" style="display: none;">
        <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 14px; color: #6b7280; font-weight: 600;">Cost Base</span>
            <span style="font-size: 20px; font-weight: bold; color: #1f2937;" id="portfolioCostBase">$0.00</span>
          </div>
        </div>
        
        <div class="two-column">
          <div class="column">
            <div class="column-title">Daily</div>
            <div class="metric">
              <div class="metric-label">Total Change</div>
              <div class="metric-value" id="dailyTotal">$0.00</div>
              <div style="font-size: 14px; color: #6b7280; margin-top: 4px;" id="dailyTotalPct"></div>
              <div class="breakdown">
                <div class="breakdown-item">
                  <span>Capital</span>
                  <span>
                    <span class="breakdown-value" id="dailyCapital">$0.00</span>
                    <span style="font-size: 11px; font-style: italic; margin-left: 4px;" id="dailyCapitalPct"></span>
                  </span>
                </div>
                <div class="breakdown-item">
                  <span>Cash</span>
                  <span>
                    <span class="breakdown-value blue" id="dailyCash">$0.00</span>
                    <span style="font-size: 11px; font-style: italic; margin-left: 4px;" id="dailyCashPct"></span>
                  </span>
                </div>
                <div style="margin-left: 12px; margin-top: 4px;">
                  <div class="breakdown-item" style="font-size: 11px;">
                    <span>Dividends</span>
                    <span>
                      <span class="breakdown-value" id="dailyDivs">$0.00</span>
                      <span style="font-size: 10px; font-style: italic; margin-left: 4px;" id="dailyDivsPct"></span>
                    </span>
                  </div>
                  <div class="breakdown-item" style="font-size: 11px;">
                    <span>Franking</span>
                    <span>
                      <span class="breakdown-value" id="dailyFrank">$0.00</span>
                      <span style="font-size: 10px; font-style: italic; margin-left: 4px;" id="dailyFrankPct"></span>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="column">
            <div class="column-title">Life-to-date</div>
            <div class="metric">
              <div class="metric-label">Total Change</div>
              <div class="metric-value" id="ltdTotal">$0.00</div>
              <div style="font-size: 14px; color: #6b7280; margin-top: 4px;" id="ltdTotalPct"></div>
              <div class="breakdown">
                <div class="breakdown-item">
                  <span>Capital</span>
                  <span>
                    <span class="breakdown-value" id="ltdCapital">$0.00</span>
                    <span style="font-size: 11px; font-style: italic; margin-left: 4px;" id="ltdCapitalPct"></span>
                  </span>
                </div>
                <div class="breakdown-item">
                  <span>Cash</span>
                  <span>
                    <span class="breakdown-value blue" id="ltdCash">$0.00</span>
                    <span style="font-size: 11px; font-style: italic; margin-left: 4px;" id="ltdCashPct"></span>
                  </span>
                </div>
                <div style="margin-left: 12px; margin-top: 4px;">
                  <div class="breakdown-item" style="font-size: 11px;">
                    <span>Dividends</span>
                    <span>
                      <span class="breakdown-value" id="ltdDivs">$0.00</span>
                      <span style="font-size: 10px; font-style: italic; margin-left: 4px;" id="ltdDivsPct"></span>
                    </span>
                  </div>
                  <div class="breakdown-item" style="font-size: 11px;">
                    <span>Franking</span>
                    <span>
                      <span class="breakdown-value" id="ltdFrank">$0.00</span>
                      <span style="font-size: 10px; font-style: italic; margin-left: 4px;" id="ltdFrankPct"></span>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ASX 200 Comparison -->
        <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-top: 16px;">
          <div style="font-size: 14px; font-weight: bold; color: #1f2937; margin-bottom: 12px;">vs ASX 200</div>
          <div class="two-column" style="gap: 12px;">
            <div>
              <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Daily</div>
              <div style="font-size: 16px; font-weight: bold;" id="vsIndexDaily">...</div>
            </div>
            <div>
              <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Life-to-date</div>
              <div style="font-size: 16px; font-weight: bold;" id="vsIndexLtd">...</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="status" id="status"></div>
    </div>
    
    <div id="stocks"></div>
  </div>

  <!-- Add/Edit Stock Modal -->
  <div id="stockModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Add Stock</h2>
      <div class="form-group">
        <label>ASX Code</label>
        <input type="text" id="stockCode" placeholder="e.g. WOW" style="text-transform: uppercase;">
      </div>
      <div class="form-group">
        <label>Quantity</label>
        <input type="number" id="stockQty" placeholder="e.g. 1000">
      </div>
      <div class="form-group">
        <label>Cost Per Share ($)</label>
        <input type="number" step="0.000001" id="stockCost" placeholder="e.g. 28.50">
      </div>
      <div class="form-buttons">
        <button class="btn-cancel" onclick="closeStockModal()">Cancel</button>
        <button class="btn-save" onclick="saveStock()">Save</button>
      </div>
    </div>
  </div>

  <script>
    let portfolio = [];
    let dividends = {};
    let editingIndex = -1;
    let indexCurrentPrice = 0;
    let indexPrevClose = 0;
    let indexStartPrice = 0; // Price on 2025-11-10

    window.addEventListener('load', () => {
      loadData();
      render();
      if (portfolio.length > 0) {
        updatePrices();
      }
    });

    function loadData() {
      const saved = localStorage.getItem('asx-portfolio');
      portfolio = saved ? JSON.parse(saved) : [];
      
      const savedDivs = localStorage.getItem('asx-dividends');
      dividends = savedDivs ? JSON.parse(savedDivs) : {};
      
      const savedIndexStart = localStorage.getItem('asx-index-start');
      indexStartPrice = savedIndexStart ? parseFloat(savedIndexStart) : 0;
    }

    function saveData() {
      localStorage.setItem('asx-portfolio', JSON.stringify(portfolio));
      localStorage.setItem('asx-dividends', JSON.stringify(dividends));
      if (indexStartPrice > 0) {
        localStorage.setItem('asx-index-start', indexStartPrice.toString());
      }
    }

    function openAddModal() {
      editingIndex = -1;
      document.getElementById('modalTitle').textContent = 'Add Stock';
      document.getElementById('stockCode').value = '';
      document.getElementById('stockQty').value = '';
      document.getElementById('stockCost').value = '';
      document.getElementById('stockCode').disabled = false;
      document.getElementById('stockModal').classList.add('show');
    }

    function openEditModal(index) {
      editingIndex = index;
      const stock = portfolio[index];
      document.getElementById('modalTitle').textContent = 'Edit Stock';
      document.getElementById('stockCode').value = stock.code;
      document.getElementById('stockQty').value = stock.qty;
      document.getElementById('stockCost').value = stock.cost;
      document.getElementById('stockCode').disabled = true;
      document.getElementById('stockModal').classList.add('show');
    }

    function closeStockModal() {
      document.getElementById('stockModal').classList.remove('show');
    }

    function saveStock() {
      const code = document.getElementById('stockCode').value.toUpperCase().trim();
      const qty = parseInt(document.getElementById('stockQty').value);
      const cost = parseFloat(document.getElementById('stockCost').value);

      if (!code || !qty || !cost || qty <= 0 || cost <= 0) {
        alert('Please fill in all fields with valid values');
        return;
      }

      if (editingIndex === -1) {
        const exists = portfolio.some(s => s.code === code);
        if (exists) {
          alert(`${code} is already in your portfolio`);
          return;
        }
        portfolio.push({ code, qty, cost, price: 0, prevClose: 0 });
      } else {
        portfolio[editingIndex].qty = qty;
        portfolio[editingIndex].cost = cost;
      }

      saveData();
      closeStockModal();
      render();
      
      if (portfolio.length === 1) {
        updatePrices();
      }
    }

    function deleteStock(index) {
      const stock = portfolio[index];
      if (confirm(`Delete ${stock.code} from portfolio?`)) {
        portfolio.splice(index, 1);
        delete dividends[stock.code];
        saveData();
        render();
      }
    }

    async function fetchPrice(code) {
      try {
        const timestamp = Date.now();
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${code}.AX?interval=1d&range=2d&_=${timestamp}`;
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
        
        const res = await fetch(proxyUrl, { cache: 'no-store' });
        
        if (!res.ok) {
          console.error(`${code}: HTTP ${res.status}`);
          return null;
        }
        
        const data = await res.json();
        const result = data?.chart?.result?.[0];
        const meta = result?.meta;
        
        // Get current price
        const price = meta?.regularMarketPrice;
        
        // Get previous close from indicators.quote.close array
        // This has the actual closing prices, not the chart reference point
        const closes = result?.indicators?.quote?.[0]?.close;
        let prevClose = null;
        
        if (closes && closes.length >= 2) {
          // Get second-to-last close (most recent previous day)
          prevClose = closes[closes.length - 2];
        } else if (closes && closes.length === 1) {
          // Fallback to first close if only one available
          prevClose = closes[0];
        }
        
        // Final fallback to meta fields if close array not available
        if (!prevClose) {
          prevClose = meta?.previousClose || meta?.chartPreviousClose;
        }
        
        if (!price || !prevClose) {
          console.error(`${code}: Missing price data`);
          return null;
        }
        
        return {
          price: price,
          prevClose: prevClose
        };
      } catch (e) {
        console.error(`${code}:`, e.message);
        return null;
      }
    }

    async function fetchIndexData() {
      try {
        const PURCHASE_TIMESTAMP = Math.floor(new Date('2025-11-10').getTime() / 1000);
        
        // Get start price if not saved
        if (!indexStartPrice || indexStartPrice === 0) {
          const startUrl = `https://query1.finance.yahoo.com/v8/finance/chart/%5EAXJO?interval=1d&period1=${PURCHASE_TIMESTAMP}&period2=${PURCHASE_TIMESTAMP + 86400}`;
          const startRes = await fetch(`https://corsproxy.io/?${encodeURIComponent(startUrl)}`);
          
          if (startRes.ok) {
            const startData = await startRes.json();
            const closes = startData?.chart?.result?.[0]?.indicators?.quote?.[0]?.close;
            if (closes && closes.length > 0) {
              indexStartPrice = closes.find(c => c !== null);
            }
          }
        }
        
        // Get current and previous close
        const timestamp = Date.now();
        const currentUrl = `https://query1.finance.yahoo.com/v8/finance/chart/%5EAXJO?interval=1d&range=2d&_=${timestamp}`;
        const currentRes = await fetch(`https://corsproxy.io/?${encodeURIComponent(currentUrl)}`, { cache: 'no-store' });
        
        if (currentRes.ok) {
          const currentData = await currentRes.json();
          const result = currentData?.chart?.result?.[0];
          const meta = result?.meta;
          
          if (meta) {
            indexCurrentPrice = meta.regularMarketPrice || 0;
            
            // Get previous close from indicators.quote.close array
            const closes = result?.indicators?.quote?.[0]?.close;
            if (closes && closes.length >= 2) {
              indexPrevClose = closes[closes.length - 2];
            } else if (closes && closes.length === 1) {
              indexPrevClose = closes[0];
            } else {
              // Fallback to meta fields
              indexPrevClose = meta.previousClose || meta.chartPreviousClose || 0;
            }
          }
        }
      } catch (e) {
        console.error('Error fetching ASX 200:', e);
      }
    }

    async function updatePrices() {
      if (portfolio.length === 0) return;
      
      const btn = document.getElementById('refreshBtn');
      const status = document.getElementById('status');
      
      btn.textContent = 'Loading...';
      btn.disabled = true;
      
      const start = Date.now();
      let success = 0;
      
      const promises = portfolio.map(async (stock) => {
        const data = await fetchPrice(stock.code);
        if (data) {
          stock.price = data.price;
          stock.prevClose = data.prevClose;
          return true;
        }
        return false;
      });
      
      const results = await Promise.all(promises);
      success = results.filter(r => r).length;
      
      // Fetch ASX 200 data
      await fetchIndexData();
      
      saveData();
      render();
      
      const elapsed = ((Date.now() - start) / 1000).toFixed(1);
      
      btn.textContent = '↻ Refresh';
      btn.disabled = false;
      
      if (success === portfolio.length) {
        status.textContent = `✓ Updated in ${elapsed}s`;
        status.style.color = '#16a34a';
        setTimeout(() => status.textContent = '', 3000);
      } else {
        status.textContent = `⚠️ ${success}/${portfolio.length} updated`;
        status.style.color = '#dc2626';
      }
    }

    function refresh() {
      updatePrices();
    }

    async function fetchDividends(code) {
      try {
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${code}.AX?interval=1mo&range=1y&events=div`;
        const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
        
        if (!res.ok) return [];
        
        const data = await res.json();
        const events = data?.chart?.result?.[0]?.events?.dividends;
        
        if (!events) return [];
        
        const startDate = new Date('2025-11-10');
        
        return Object.values(events)
          .map(d => ({
            date: new Date(d.date * 1000),
            amount: d.amount
          }))
          .filter(d => d.date >= startDate);
      } catch (e) {
        return [];
      }
    }

    async function syncDividends() {
      if (portfolio.length === 0) return;
      
      const btn = document.getElementById('syncBtn');
      const status = document.getElementById('status');
      
      btn.textContent = 'Syncing...';
      btn.disabled = true;
      
      let newCount = 0;
      
      for (const stock of portfolio) {
        const apiDivs = await fetchDividends(stock.code);
        
        if (!dividends[stock.code]) dividends[stock.code] = [];
        
        for (const apiDiv of apiDivs) {
          const dateStr = apiDiv.date.toISOString().split('T')[0];
          const exists = dividends[stock.code].some(d => d.date === dateStr);
          
          if (!exists) {
            dividends[stock.code].push({
              date: dateStr,
              amount: apiDiv.amount,
              franking: 100
            });
            newCount++;
          }
        }
        
        dividends[stock.code].sort((a, b) => new Date(b.date) - new Date(a.date));
      }
      
      saveData();
      render();
      
      btn.textContent = '⟳ Sync';
      btn.disabled = false;
      
      status.textContent = newCount > 0 ? `✓ Added ${newCount} dividend${newCount > 1 ? 's' : ''}` : `✓ Up to date`;
      status.style.color = '#16a34a';
      setTimeout(() => status.textContent = '', 3000);
    }

    function calculateDividends(code, qty) {
      const divs = dividends[code] || [];
      let totalDiv = 0;
      let totalFranking = 0;
      
      for (const d of divs) {
        const amount = d.amount * qty;
        totalDiv += amount;
        totalFranking += amount * (d.franking / 100) * (30 / 70);
      }
      
      return { totalDiv, totalFranking };
    }

    function calculateTodaysDividends(code, qty) {
      const divs = dividends[code] || [];
      const today = new Date().toISOString().split('T')[0];
      
      let todayDiv = 0;
      let todayFranking = 0;
      
      for (const d of divs) {
        if (d.date === today) {
          const amount = d.amount * qty;
          todayDiv += amount;
          todayFranking += amount * (d.franking / 100) * (30 / 70);
        }
      }
      
      return { todayDiv, todayFranking };
    }

    function render() {
      if (portfolio.length === 0) {
        document.getElementById('portfolioSummary').style.display = 'none';
        document.getElementById('stocks').innerHTML = `
          <div class="card empty-state">
            <h2>No Stocks Yet</h2>
            <p>Click "+ Add" to start building your portfolio</p>
          </div>
        `;
        return;
      }
      
      document.getElementById('portfolioSummary').style.display = 'block';
      renderPortfolio();
      renderStocks();
    }

    function renderPortfolio() {
      let totalCost = 0;
      let totalValue = 0;
      let totalPrevValue = 0;
      let totalDivs = 0;
      let totalFranking = 0;
      let todayDivs = 0;
      let todayFranking = 0;
      
      for (const stock of portfolio) {
        const cost = stock.cost * stock.qty;
        const value = stock.price * stock.qty;
        const prevValue = stock.prevClose * stock.qty;
        
        totalCost += cost;
        totalValue += value;
        totalPrevValue += prevValue;
        
        const divs = calculateDividends(stock.code, stock.qty);
        totalDivs += divs.totalDiv;
        totalFranking += divs.totalFranking;
        
        const today = calculateTodaysDividends(stock.code, stock.qty);
        todayDivs += today.todayDiv;
        todayFranking += today.todayFranking;
      }
      
      const dailyCapital = totalValue - totalPrevValue;
      const dailyCash = todayDivs + todayFranking;
      const dailyTotal = dailyCapital + dailyCash;
      
      // Set cost base
      document.getElementById('portfolioCostBase').textContent = fmt(totalCost);
      
      // Daily column
      document.getElementById('dailyTotal').textContent = fmt(dailyTotal);
      document.getElementById('dailyTotal').className = `metric-value ${dailyTotal >= 0 ? 'green' : 'red'}`;
      document.getElementById('dailyCapital').textContent = fmt(dailyCapital);
      document.getElementById('dailyCapital').className = `breakdown-value ${dailyCapital >= 0 ? 'green' : 'red'}`;
      document.getElementById('dailyCash').textContent = fmt(dailyCash);
      document.getElementById('dailyDivs').textContent = fmt(todayDivs);
      document.getElementById('dailyFrank').textContent = fmt(todayFranking);
      
      // Daily breakdown percentages
      const dailyCapitalPct = totalPrevValue > 0 ? (dailyCapital / totalPrevValue) * 100 : 0;
      const dailyCashPct = totalPrevValue > 0 ? (dailyCash / totalPrevValue) * 100 : 0;
      document.getElementById('dailyCapitalPct').textContent = `(${dailyCapitalPct >= 0 ? '+' : ''}${dailyCapitalPct.toFixed(2)}%)`;
      document.getElementById('dailyCapitalPct').style.color = dailyCapital >= 0 ? '#16a34a' : '#dc2626';
      document.getElementById('dailyCashPct').textContent = dailyCash !== 0 ? `(${dailyCashPct >= 0 ? '+' : ''}${dailyCashPct.toFixed(2)}%)` : '';
      document.getElementById('dailyCashPct').style.color = '#2563eb';
      
      const dailyDivsPct = totalPrevValue > 0 ? (todayDivs / totalPrevValue) * 100 : 0;
      const dailyFrankPct = totalPrevValue > 0 ? (todayFranking / totalPrevValue) * 100 : 0;
      document.getElementById('dailyDivsPct').textContent = todayDivs !== 0 ? `(${dailyDivsPct >= 0 ? '+' : ''}${dailyDivsPct.toFixed(2)}%)` : '';
      document.getElementById('dailyDivsPct').style.color = '#2563eb';
      document.getElementById('dailyFrankPct').textContent = todayFranking !== 0 ? `(${dailyFrankPct >= 0 ? '+' : ''}${dailyFrankPct.toFixed(2)}%)` : '';
      document.getElementById('dailyFrankPct').style.color = '#2563eb';
      
      // Life-to-date column
      const ltdCapital = totalValue - totalCost;
      const ltdCash = totalDivs + totalFranking;
      const ltdTotal = ltdCapital + ltdCash;
      
      document.getElementById('ltdTotal').textContent = fmt(ltdTotal);
      document.getElementById('ltdTotal').className = `metric-value ${ltdTotal >= 0 ? 'green' : 'red'}`;
      document.getElementById('ltdCapital').textContent = fmt(ltdCapital);
      document.getElementById('ltdCapital').className = `breakdown-value ${ltdCapital >= 0 ? 'green' : 'red'}`;
      document.getElementById('ltdCash').textContent = fmt(ltdCash);
      document.getElementById('ltdDivs').textContent = fmt(totalDivs);
      document.getElementById('ltdFrank').textContent = fmt(totalFranking);
      
      // Life-to-date breakdown percentages
      const ltdCapitalPct = totalCost > 0 ? (ltdCapital / totalCost) * 100 : 0;
      const ltdCashPct = totalCost > 0 ? (ltdCash / totalCost) * 100 : 0;
      document.getElementById('ltdCapitalPct').textContent = `(${ltdCapitalPct >= 0 ? '+' : ''}${ltdCapitalPct.toFixed(2)}%)`;
      document.getElementById('ltdCapitalPct').style.color = ltdCapital >= 0 ? '#16a34a' : '#dc2626';
      document.getElementById('ltdCashPct').textContent = ltdCash !== 0 ? `(${ltdCashPct >= 0 ? '+' : ''}${ltdCashPct.toFixed(2)}%)` : '';
      document.getElementById('ltdCashPct').style.color = '#2563eb';
      
      const ltdDivsPct = totalCost > 0 ? (totalDivs / totalCost) * 100 : 0;
      const ltdFrankPct = totalCost > 0 ? (totalFranking / totalCost) * 100 : 0;
      document.getElementById('ltdDivsPct').textContent = totalDivs !== 0 ? `(${ltdDivsPct >= 0 ? '+' : ''}${ltdDivsPct.toFixed(2)}%)` : '';
      document.getElementById('ltdDivsPct').style.color = '#2563eb';
      document.getElementById('ltdFrankPct').textContent = totalFranking !== 0 ? `(${ltdFrankPct >= 0 ? '+' : ''}${ltdFrankPct.toFixed(2)}%)` : '';
      document.getElementById('ltdFrankPct').style.color = '#2563eb';
      
      // Calculate percentages
      const dailyPct = totalPrevValue > 0 ? (dailyTotal / totalPrevValue) * 100 : 0;
      const ltdPct = totalCost > 0 ? (ltdTotal / totalCost) * 100 : 0;
      
      document.getElementById('dailyTotalPct').textContent = `(${dailyPct >= 0 ? '+' : ''}${dailyPct.toFixed(2)}%)`;
      document.getElementById('dailyTotalPct').style.color = dailyPct >= 0 ? '#16a34a' : '#dc2626';
      
      document.getElementById('ltdTotalPct').textContent = `(${ltdPct >= 0 ? '+' : ''}${ltdPct.toFixed(2)}%)`;
      document.getElementById('ltdTotalPct').style.color = ltdPct >= 0 ? '#16a34a' : '#dc2626';
      
      // ASX 200 comparison
      if (indexCurrentPrice > 0 && indexPrevClose > 0) {
        const indexDailyChange = ((indexCurrentPrice - indexPrevClose) / indexPrevClose) * 100;
        const portfolioDailyPct = dailyPct;
        const vsIndexDaily = portfolioDailyPct - indexDailyChange;
        
        document.getElementById('vsIndexDaily').textContent = `${vsIndexDaily >= 0 ? '+' : ''}${vsIndexDaily.toFixed(2)}%`;
        document.getElementById('vsIndexDaily').style.color = vsIndexDaily >= 0 ? '#16a34a' : '#dc2626';
      } else {
        document.getElementById('vsIndexDaily').textContent = '...';
        document.getElementById('vsIndexDaily').style.color = '#6b7280';
      }
      
      if (indexCurrentPrice > 0 && indexStartPrice > 0 && totalCost > 0) {
        const indexLtdChange = ((indexCurrentPrice - indexStartPrice) / indexStartPrice) * 100;
        const portfolioLtdPct = ltdPct;
        const vsIndexLtd = portfolioLtdPct - indexLtdChange;
        
        document.getElementById('vsIndexLtd').textContent = `${vsIndexLtd >= 0 ? '+' : ''}${vsIndexLtd.toFixed(2)}%`;
        document.getElementById('vsIndexLtd').style.color = vsIndexLtd >= 0 ? '#16a34a' : '#dc2626';
      } else {
        document.getElementById('vsIndexLtd').textContent = '...';
        document.getElementById('vsIndexLtd').style.color = '#6b7280';
      }
    }

    function renderStocks() {
      let html = '';
      
      for (let i = 0; i < portfolio.length; i++) {
        const stock = portfolio[i];
        const cost = stock.cost * stock.qty;
        const value = stock.price * stock.qty;
        const prevValue = stock.prevClose * stock.qty;
        
        const dailyCapital = value - prevValue;
        const todayDivs = calculateTodaysDividends(stock.code, stock.qty);
        const dailyCash = todayDivs.todayDiv + todayDivs.todayFranking;
        const dailyTotal = dailyCapital + dailyCash;
        
        const divs = calculateDividends(stock.code, stock.qty);
        const ltdCapital = value - cost;
        const ltdCash = divs.totalDiv + divs.totalFranking;
        const ltdTotal = ltdCapital + ltdCash;
        
        // Calculate percentages
        const dailyPct = prevValue > 0 ? (dailyTotal / prevValue) * 100 : 0;
        const ltdPct = cost > 0 ? (ltdTotal / cost) * 100 : 0;
        
        const stockDivs = dividends[stock.code] || [];

        html += `
          <div class="stock">
            <div class="stock-header">
              <div>
                <div class="stock-code">${stock.code}</div>
                <div class="stock-qty">${stock.qty.toLocaleString()} @ ${fmt(stock.cost)}</div>
              </div>
              <div>
                <div class="stock-price-label">Current</div>
                <div class="stock-price-value">${stock.price > 0 ? fmt(stock.price) : '...'}</div>
              </div>
            </div>
            
            <div style="background: #f9fafb; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 13px; color: #6b7280; font-weight: 600;">Cost Base</span>
                <span style="font-size: 16px; font-weight: bold; color: #1f2937;">${fmt(cost)}</span>
              </div>
            </div>
            
            <div class="two-column">
              <div class="column">
                <div class="column-title">Daily</div>
                <div class="metric">
                  <div class="metric-label">Change</div>
                  <div class="metric-value ${stock.price > 0 ? (dailyTotal >= 0 ? 'green' : 'red') : ''}">
                    ${stock.price > 0 ? fmt(dailyTotal) : '...'}
                  </div>
                  <div style="font-size: 14px; color: ${stock.price > 0 ? (dailyPct >= 0 ? '#16a34a' : '#dc2626') : '#6b7280'}; margin-top: 4px;">
                    ${stock.price > 0 ? `(${dailyPct >= 0 ? '+' : ''}${dailyPct.toFixed(2)}%)` : ''}
                  </div>
                  <div class="breakdown">
                    <div class="breakdown-item">
                      <span>Capital</span>
                      <span>
                        <span class="breakdown-value ${stock.price > 0 ? (dailyCapital >= 0 ? 'green' : 'red') : ''}">
                          ${stock.price > 0 ? fmt(dailyCapital) : '$0.00'}
                        </span>
                        <span style="font-size: 11px; font-style: italic; margin-left: 4px; color: ${stock.price > 0 ? (dailyCapital >= 0 ? '#16a34a' : '#dc2626') : '#6b7280'};">
                          ${stock.price > 0 && prevValue > 0 ? `(${((dailyCapital / prevValue) * 100) >= 0 ? '+' : ''}${((dailyCapital / prevValue) * 100).toFixed(2)}%)` : ''}
                        </span>
                      </span>
                    </div>
                    <div class="breakdown-item">
                      <span>Cash</span>
                      <span>
                        <span class="breakdown-value ${dailyCash > 0 ? 'blue' : ''}">${fmt(dailyCash)}</span>
                        <span style="font-size: 11px; font-style: italic; margin-left: 4px; color: #2563eb;">
                          ${stock.price > 0 && prevValue > 0 && dailyCash !== 0 ? `(${((dailyCash / prevValue) * 100) >= 0 ? '+' : ''}${((dailyCash / prevValue) * 100).toFixed(2)}%)` : ''}
                        </span>
                      </span>
                    </div>
                    <div style="margin-left: 12px; margin-top: 4px;">
                      <div class="breakdown-item" style="font-size: 11px;">
                        <span>Dividends</span>
                        <span>
                          <span class="breakdown-value">${fmt(todayDivs.todayDiv)}</span>
                          <span style="font-size: 10px; font-style: italic; margin-left: 4px; color: #2563eb;">
                            ${stock.price > 0 && prevValue > 0 && todayDivs.todayDiv !== 0 ? `(${((todayDivs.todayDiv / prevValue) * 100) >= 0 ? '+' : ''}${((todayDivs.todayDiv / prevValue) * 100).toFixed(2)}%)` : ''}
                          </span>
                        </span>
                      </div>
                      <div class="breakdown-item" style="font-size: 11px;">
                        <span>Franking</span>
                        <span>
                          <span class="breakdown-value">${fmt(todayDivs.todayFranking)}</span>
                          <span style="font-size: 10px; font-style: italic; margin-left: 4px; color: #2563eb;">
                            ${stock.price > 0 && prevValue > 0 && todayDivs.todayFranking !== 0 ? `(${((todayDivs.todayFranking / prevValue) * 100) >= 0 ? '+' : ''}${((todayDivs.todayFranking / prevValue) * 100).toFixed(2)}%)` : ''}
                          </span>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="column">
                <div class="column-title">Life-to-date</div>
                <div class="metric">
                  <div class="metric-label">Change</div>
                  <div class="metric-value ${stock.price > 0 ? (ltdTotal >= 0 ? 'green' : 'red') : ''}">
                    ${stock.price > 0 ? fmt(ltdTotal) : '...'}
                  </div>
                  <div style="font-size: 14px; color: ${stock.price > 0 ? (ltdPct >= 0 ? '#16a34a' : '#dc2626') : '#6b7280'}; margin-top: 4px;">
                    ${stock.price > 0 ? `(${ltdPct >= 0 ? '+' : ''}${ltdPct.toFixed(2)}%)` : ''}
                  </div>
                  <div class="breakdown">
                    <div class="breakdown-item">
                      <span>Capital</span>
                      <span>
                        <span class="breakdown-value ${stock.price > 0 ? (ltdCapital >= 0 ? 'green' : 'red') : ''}">
                          ${stock.price > 0 ? fmt(ltdCapital) : '$0.00'}
                        </span>
                        <span style="font-size: 11px; font-style: italic; margin-left: 4px; color: ${stock.price > 0 ? (ltdCapital >= 0 ? '#16a34a' : '#dc2626') : '#6b7280'};">
                          ${stock.price > 0 && cost > 0 ? `(${((ltdCapital / cost) * 100) >= 0 ? '+' : ''}${((ltdCapital / cost) * 100).toFixed(2)}%)` : ''}
                        </span>
                      </span>
                    </div>
                    <div class="breakdown-item">
                      <span>Cash</span>
                      <span>
                        <span class="breakdown-value blue">${fmt(ltdCash)}</span>
                        <span style="font-size: 11px; font-style: italic; margin-left: 4px; color: #2563eb;">
                          ${cost > 0 && ltdCash !== 0 ? `(${((ltdCash / cost) * 100) >= 0 ? '+' : ''}${((ltdCash / cost) * 100).toFixed(2)}%)` : ''}
                        </span>
                      </span>
                    </div>
                    <div style="margin-left: 12px; margin-top: 4px;">
                      <div class="breakdown-item" style="font-size: 11px;">
                        <span>Dividends</span>
                        <span>
                          <span class="breakdown-value">${fmt(divs.totalDiv)}</span>
                          <span style="font-size: 10px; font-style: italic; margin-left: 4px; color: #2563eb;">
                            ${cost > 0 && divs.totalDiv !== 0 ? `(${((divs.totalDiv / cost) * 100) >= 0 ? '+' : ''}${((divs.totalDiv / cost) * 100).toFixed(2)}%)` : ''}
                          </span>
                        </span>
                      </div>
                      <div class="breakdown-item" style="font-size: 11px;">
                        <span>Franking</span>
                        <span>
                          <span class="breakdown-value">${fmt(divs.totalFranking)}</span>
                          <span style="font-size: 10px; font-style: italic; margin-left: 4px; color: #2563eb;">
                            ${cost > 0 && divs.totalFranking !== 0 ? `(${((divs.totalFranking / cost) * 100) >= 0 ? '+' : ''}${((divs.totalFranking / cost) * 100).toFixed(2)}%)` : ''}
                          </span>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            ${stockDivs.length > 0 ? `
              <div class="dividend-list">
                ${stockDivs.map(d => `
                  <div class="dividend-item">
                    <span class="dividend-date">${d.date}</span>
                    <span>$${d.amount.toFixed(4)}</span>
                  </div>
                `).join('')}
              </div>
            ` : ''}
            
            <div class="stock-actions">
              <button class="btn-small btn-edit" onclick="openEditModal(${i})">Edit</button>
              <button class="btn-small btn-delete" onclick="deleteStock(${i})">Delete</button>
            </div>
          </div>
        `;
      }

      document.getElementById('stocks').innerHTML = html;
    }

    function fmt(n) {
      return '$' + n.toLocaleString('en-AU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
  </script>
</body>
</html>
