<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASX Portfolio Tracker</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#6366f1">
  
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #e0f2fe 0%, #ddd6fe 100%);
      min-height: 100vh;
      padding: 16px;
    }
    
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 16px;
    }
    
    h1 { 
      font-size: 24px; 
      color: #1f2937; 
      flex-shrink: 0; 
    }
    
    .header-buttons {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .btn {
      padding: 10px 18px;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-latest { background: #6366f1; }
    .btn-divs { background: #10b981; }
    
    .market-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
    
    .market-open {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .market-closed {
      background: #fee2e2;
      color: #dc2626;
    }
    
    /* COST BASE */
    .cost-base {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .cost-base-label {
      font-size: 14px;
      color: #6b7280;
      font-weight: 600;
    }
    
    .cost-base-value {
      font-size: 20px;
      font-weight: bold;
      color: #1f2937;
    }
    
    /* TWO COLUMN LAYOUT */
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .column {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
    }
    
    .column-title {
      font-size: 16px;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    /* METRICS */
    .metric { 
      margin-bottom: 12px; 
    }
    
    .metric-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #1f2937;
    }
    
    .metric-pct {
      font-size: 14px;
      margin-top: 4px;
    }
    
    .green { color: #16a34a; }
    .red { color: #dc2626; }
    .blue { color: #2563eb; }
    
    /* BREAKDOWN */
    .breakdown {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    
    .breakdown-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      font-size: 12px;
      color: #6b7280;
    }
    
    .breakdown-label { 
      font-weight: 500; 
    }
    
    .breakdown-value {
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }
    
    .breakdown-pct {
      font-size: 11px;
      font-style: italic;
    }
    
    .sub-breakdown {
      margin-left: 16px;
      margin-top: 4px;
    }
    
    .sub-breakdown .breakdown-row {
      font-size: 11px;
      margin-bottom: 4px;
    }
    
    .sub-breakdown .breakdown-value {
      font-size: 11px;
    }
    
    .sub-breakdown .breakdown-pct {
      font-size: 10px;
    }
    
    /* STOCK CARDS */
    .stock {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stock-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .stock-code { 
      font-size: 18px; 
      font-weight: bold; 
      color: #1f2937; 
    }
    
    .stock-qty { 
      font-size: 12px; 
      color: #6b7280; 
      margin-top: 4px; 
    }
    
    .stock-current { 
      text-align: right; 
    }
    
    .stock-price-label { 
      font-size: 11px; 
      color: #6b7280; 
      margin-bottom: 4px; 
    }
    
    .stock-price-value { 
      font-size: 16px; 
      font-weight: bold; 
      color: #1f2937; 
    }
    
    .stock-cost-base {
      background: #f9fafb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .stock-cost-base .cost-base-label { 
      font-size: 13px; 
    }
    
    .stock-cost-base .cost-base-value { 
      font-size: 16px; 
    }
    
    /* DIVIDENDS */
    .dividend-list {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .dividend-item {
      display: grid;
      grid-template-columns: auto auto 1fr;
      gap: 12px;
      align-items: center;
      font-size: 12px;
      color: #6b7280;
      padding: 6px 0;
    }
    
    .dividend-date { 
      color: #1f2937; 
      font-weight: 600; 
    }
    
    .dividend-franking {
      text-align: right;
      font-size: 11px;
      color: #6366f1;
      cursor: pointer;
      font-weight: 600;
    }
    
    .dividend-franking:hover { 
      text-decoration: underline; 
    }
    
    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    
    .empty-state h2 {
      font-size: 18px;
      margin-bottom: 8px;
      color: #1f2937;
    }
    
    .empty-state p {
      font-size: 14px;
    }
    
    /* STATUS */
    .status {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
      text-align: center;
    }
    
    /* MOBILE RESPONSIVE */
    @media (max-width: 640px) {
      body { padding: 12px; }
      .card { padding: 16px; }
      
      .header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      h1 {
        text-align: center;
        font-size: 22px;
      }
      
      .market-status {
        display: block;
        margin: 8px auto 0;
        font-size: 10px;
        padding: 3px 8px;
      }
      
      .header-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }
      
      .btn {
        padding: 12px 8px;
        font-size: 13px;
        min-height: 44px;
      }
      
      .cost-base {
        padding: 12px;
      }
      
      .cost-base-label { font-size: 12px; }
      .cost-base-value { font-size: 18px; }
      
      .two-column {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .column {
        padding: 12px;
      }
      
      .column-title {
        font-size: 14px;
      }
      
      .metric-value { font-size: 16px; }
      .metric-pct { font-size: 12px; }
      
      .breakdown-row { font-size: 11px; }
      .breakdown-pct { font-size: 10px; }
      .sub-breakdown .breakdown-row { font-size: 10px; }
      .sub-breakdown .breakdown-pct { font-size: 9px; }
      
      .stock { padding: 14px; }
      .stock-code { font-size: 16px; }
      .stock-qty { font-size: 11px; }
      .stock-price-value { font-size: 14px; }
      
      .stock-cost-base {
        padding: 10px;
      }
      
      .stock-cost-base .cost-base-value { font-size: 14px; }
      
      .dividend-item {
        font-size: 10px;
        gap: 8px;
      }
      
      .dividend-franking { font-size: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1>
          ASX Portfolio
          <span id="marketStatusBadge" class="market-status market-closed">Market Closed</span>
        </h1>
        <div class="header-buttons">
          <button class="btn btn-latest" id="refreshBtn" onclick="refresh()">Latest</button>
          <button class="btn btn-divs" id="syncBtn" onclick="syncDividends()">Divs</button>
        </div>
      </div>
      
      <div id="portfolioSummary" style="display: none;">
        <div class="cost-base">
          <span class="cost-base-label">Cost Base</span>
          <span class="cost-base-value" id="portfolioCostBase">$0.00</span>
        </div>
        
        <div class="two-column">
          <div class="column">
            <div class="column-title">Daily</div>
            
            <div class="metric">
              <div class="metric-label">Total Change</div>
              <div class="metric-value" id="dailyTotal">$0.00</div>
              <div class="metric-pct" id="dailyTotalPct"></div>
            </div>
            
            <div class="breakdown">
              <div class="breakdown-row">
                <span class="breakdown-label">Capital</span>
                <span class="breakdown-value">
                  <span id="dailyCapital">$0.00</span>
                  <span class="breakdown-pct" id="dailyCapitalPct"></span>
                </span>
              </div>
              
              <div class="breakdown-row">
                <span class="breakdown-label">Cash</span>
                <span class="breakdown-value blue">
                  <span id="dailyCash">$0.00</span>
                  <span class="breakdown-pct" id="dailyCashPct"></span>
                </span>
              </div>
              
              <div class="sub-breakdown">
                <div class="breakdown-row">
                  <span class="breakdown-label">Dividends</span>
                  <span class="breakdown-value blue">
                    <span id="dailyDivs">$0.00</span>
                    <span class="breakdown-pct" id="dailyDivsPct"></span>
                  </span>
                </div>
                <div class="breakdown-row">
                  <span class="breakdown-label">Franking</span>
                  <span class="breakdown-value blue">
                    <span id="dailyFrank">$0.00</span>
                    <span class="breakdown-pct" id="dailyFrankPct"></span>
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="column">
            <div class="column-title">Life-to-date</div>
            
            <div class="metric">
              <div class="metric-label">Total Change</div>
              <div class="metric-value" id="ltdTotal">$0.00</div>
              <div class="metric-pct" id="ltdTotalPct"></div>
            </div>
            
            <div class="breakdown">
              <div class="breakdown-row">
                <span class="breakdown-label">Capital</span>
                <span class="breakdown-value">
                  <span id="ltdCapital">$0.00</span>
                  <span class="breakdown-pct" id="ltdCapitalPct"></span>
                </span>
              </div>
              
              <div class="breakdown-row">
                <span class="breakdown-label">Cash</span>
                <span class="breakdown-value blue">
                  <span id="ltdCash">$0.00</span>
                  <span class="breakdown-pct" id="ltdCashPct"></span>
                </span>
              </div>
              
              <div class="sub-breakdown">
                <div class="breakdown-row">
                  <span class="breakdown-label">Dividends</span>
                  <span class="breakdown-value blue">
                    <span id="ltdDivs">$0.00</span>
                    <span class="breakdown-pct" id="ltdDivsPct"></span>
                  </span>
                </div>
                <div class="breakdown-row">
                  <span class="breakdown-label">Franking</span>
                  <span class="breakdown-value blue">
                    <span id="ltdFrank">$0.00</span>
                    <span class="breakdown-pct" id="ltdFrankPct"></span>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="status" id="status"></div>
    </div>
    
    <div id="stocks"></div>
    
    <div id="emptyState" class="card empty-state">
      <h2>No Stocks Yet</h2>
      <p>Add stocks via localStorage to start tracking</p>
    </div>
  </div>

  <script>
    /* ==========================================
       GLOBAL STATE
       ========================================== */
    let portfolio = [];
    let dividends = {};

    /* ==========================================
       DATE & TIME (Australia/Sydney)
       ========================================== */
    
    function getTodayAU() {
      const now = new Date();
      const auNow = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
      const year = auNow.getFullYear();
      const month = String(auNow.getMonth() + 1).padStart(2, '0');
      const day = String(auNow.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function isMarketOpen() {
      const now = new Date();
      const auNow = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
      
      const day = auNow.getDay();
      const hour = auNow.getHours();
      const minute = auNow.getMinutes();
      
      if (day === 0 || day === 6) return false;
      
      const timeInMinutes = hour * 60 + minute;
      const marketOpen = 10 * 60;
      const marketClose = 16 * 60 + 30;
      
      return timeInMinutes >= marketOpen && timeInMinutes < marketClose;
    }

    function getMarketStatusText() {
      const now = new Date();
      const auNow = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
      const day = auNow.getDay();
      const hour = auNow.getHours();
      const minute = auNow.getMinutes();
      
      if (day === 0 || day === 6) {
        return 'Market Closed (Weekend)';
      }
      
      const timeInMinutes = hour * 60 + minute;
      const marketOpen = 10 * 60;
      const marketClose = 16 * 60 + 30;
      
      if (timeInMinutes < marketOpen) {
        const minsUntilOpen = marketOpen - timeInMinutes;
        const hoursUntil = Math.floor(minsUntilOpen / 60);
        const minsUntil = minsUntilOpen % 60;
        return `Opens in ${hoursUntil}h ${minsUntil}m`;
      } else if (timeInMinutes >= marketClose) {
        return 'Market Closed';
      } else {
        return 'Market Open';
      }
    }

    /* ==========================================
       DATA PERSISTENCE
       ========================================== */

    function loadData() {
      const saved = localStorage.getItem('asx-portfolio-simple');
      if (saved) {
        portfolio = JSON.parse(saved);
      } else {
        // Migration from old formats
        const v2 = localStorage.getItem('asx-portfolio-v2');
        const v1 = localStorage.getItem('asx-portfolio');
        
        if (v2) {
          const oldPortfolio = JSON.parse(v2);
          portfolio = oldPortfolio.map(stock => ({
            code: stock.code,
            qty: stock.qty,
            cost: stock.cost,
            currentPrice: stock.currentPrice || 0,
            prevClose: 0
          }));
        } else if (v1) {
          const oldPortfolio = JSON.parse(v1);
          portfolio = oldPortfolio.map(stock => ({
            code: stock.code,
            qty: stock.qty,
            cost: stock.cost,
            currentPrice: stock.price || 0,
            prevClose: 0
          }));
        }
      }
      
      const savedDivs = localStorage.getItem('asx-dividends');
      dividends = savedDivs ? JSON.parse(savedDivs) : {};
    }

    function saveData() {
      localStorage.setItem('asx-portfolio-simple', JSON.stringify(portfolio));
      localStorage.setItem('asx-dividends', JSON.stringify(dividends));
    }

    /* ==========================================
       PRICE FETCHING (Yahoo Finance)
       ========================================== */

    async function fetchPrice(code) {
      try {
        const timestamp = Date.now();
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${code}.AX?interval=1d&range=5d&_=${timestamp}`;
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
        
        const res = await fetch(proxyUrl, { cache: 'no-store' });
        if (!res.ok) return null;
        
        const data = await res.json();
        const result = data?.chart?.result?.[0];
        const meta = result?.meta;
        
        if (!meta) return null;
        
        const currentPrice = meta.regularMarketPrice;
        if (!currentPrice) return null;
        
        // Parse closes array for yesterday's actual close
        const closes = result?.indicators?.quote?.[0]?.close;
        const timestamps = result?.timestamp;
        
        if (!closes || !timestamps || closes.length < 2) {
          const prevClose = meta.chartPreviousClose || meta.previousClose;
          return prevClose ? { currentPrice, prevClose } : null;
        }
        
        // Build array of date/close pairs
        const dailyData = [];
        for (let i = 0; i < timestamps.length; i++) {
          if (closes[i] !== null) {
            const utcDate = new Date(timestamps[i] * 1000);
            const auDate = new Date(utcDate.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
            const year = auDate.getFullYear();
            const month = String(auDate.getMonth() + 1).padStart(2, '0');
            const day = String(auDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            dailyData.push({ date: dateStr, close: closes[i] });
          }
        }
        
        dailyData.sort((a, b) => b.date.localeCompare(a.date));
        
        // Calculate yesterday (skip weekends)
        const today = getTodayAU();
        const yesterdayDate = new Date(today + 'T12:00:00');
        yesterdayDate.setDate(yesterdayDate.getDate() - 1);
        while (yesterdayDate.getDay() === 0 || yesterdayDate.getDay() === 6) {
          yesterdayDate.setDate(yesterdayDate.getDate() - 1);
        }
        const yesterday = yesterdayDate.toISOString().split('T')[0];
        
        // Look for exact yesterday
        const yesterdayData = dailyData.find(d => d.date === yesterday);
        
        if (yesterdayData) {
          return { currentPrice, prevClose: yesterdayData.close };
        } else {
          // Fallback to chartPreviousClose if yesterday missing
          const prevClose = meta.chartPreviousClose || meta.previousClose;
          return prevClose ? { currentPrice, prevClose } : null;
        }
      } catch (e) {
        console.error(`${code}:`, e);
        return null;
      }
    }

    /* ==========================================
       PRICE UPDATE
       ========================================== */

    async function updatePrices() {
      if (portfolio.length === 0) return;
      
      if (!isMarketOpen()) {
        const status = document.getElementById('status');
        status.textContent = 'Market closed - refresh during trading hours (10 AM - 4:30 PM)';
        status.style.color = '#dc2626';
        setTimeout(() => {
          status.textContent = '';
        }, 3000);
        return;
      }
      
      const btn = document.getElementById('refreshBtn');
      const status = document.getElementById('status');
      
      btn.textContent = '...';
      btn.disabled = true;
      
      const start = Date.now();
      
      const promises = portfolio.map(async (stock) => {
        const data = await fetchPrice(stock.code);
        if (!data) return false;
        
        stock.currentPrice = data.currentPrice;
        stock.prevClose = data.prevClose;
        
        return true;
      });
      
      const results = await Promise.all(promises);
      const success = results.filter(r => r).length;
      
      saveData();
      render();
      
      const elapsed = ((Date.now() - start) / 1000).toFixed(1);
      
      btn.textContent = 'Latest';
      btn.disabled = false;
      
      if (success === portfolio.length) {
        status.textContent = `✓ ${elapsed}s`;
        status.style.color = '#16a34a';
        
        setTimeout(() => {
          status.textContent = '';
        }, 3000);
      } else {
        status.textContent = `⚠️ ${success}/${portfolio.length}`;
        status.style.color = '#dc2626';
      }
    }

    function refresh() {
      updatePrices();
    }

    /* ==========================================
       MARKET STATUS UI
       ========================================== */

    function updateMarketStatus() {
      const btn = document.getElementById('refreshBtn');
      const badge = document.getElementById('marketStatusBadge');
      const marketOpen = isMarketOpen();
      
      if (!marketOpen) {
        btn.disabled = true;
        btn.title = 'Market closed - refresh available 10 AM - 4:30 PM';
      } else {
        if (portfolio.length > 0) {
          btn.disabled = false;
        }
        btn.title = 'Refresh prices';
      }
      
      if (marketOpen) {
        badge.textContent = 'Market Open';
        badge.className = 'market-status market-open';
      } else {
        badge.textContent = getMarketStatusText();
        badge.className = 'market-status market-closed';
      }
    }

    /* ==========================================
       DIVIDENDS
       ========================================== */

    async function fetchDividends(code) {
      try {
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${code}.AX?interval=1mo&range=1y&events=div`;
        const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
        
        if (!res.ok) return [];
        
        const data = await res.json();
        const events = data?.chart?.result?.[0]?.events?.dividends;
        if (!events) return [];
        
        const startDateStr = '2025-11-10';
        
        return Object.values(events)
          .map(d => {
            const utcDate = new Date(d.date * 1000);
            const auDate = new Date(utcDate.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
            
            const year = auDate.getFullYear();
            const month = String(auDate.getMonth() + 1).padStart(2, '0');
            const day = String(auDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            return {
              dateStr: dateStr,
              amount: d.amount
            };
          })
          .filter(d => d.dateStr >= startDateStr);
      } catch (e) {
        return [];
      }
    }

    async function syncDividends() {
      if (portfolio.length === 0) return;
      
      const btn = document.getElementById('syncBtn');
      const status = document.getElementById('status');
      
      btn.textContent = '...';
      btn.disabled = true;
      
      let newCount = 0;
      
      for (const stock of portfolio) {
        const apiDivs = await fetchDividends(stock.code);
        
        if (!dividends[stock.code]) dividends[stock.code] = [];
        
        for (const apiDiv of apiDivs) {
          const dateStr = apiDiv.dateStr;
          const exists = dividends[stock.code].some(d => d.date === dateStr);
          
          if (!exists) {
            dividends[stock.code].push({
              date: dateStr,
              amount: apiDiv.amount,
              franking: 100
            });
            newCount++;
          }
        }
        
        dividends[stock.code].sort((a, b) => new Date(b.date) - new Date(a.date));
      }
      
      saveData();
      render();
      
      btn.textContent = 'Divs';
      btn.disabled = false;
      
      status.textContent = newCount > 0 ? `✓ +${newCount}` : `✓`;
      status.style.color = '#16a34a';
      setTimeout(() => status.textContent = '', 3000);
    }

    function calculateDividends(code, qty) {
      const divs = dividends[code] || [];
      let totalDiv = 0;
      let totalFranking = 0;
      
      for (const d of divs) {
        const amount = d.amount * qty;
        totalDiv += amount;
        totalFranking += amount * (d.franking / 100) * (30 / 70);
      }
      
      return { totalDiv, totalFranking };
    }

    function calculateTodaysDividends(code, qty) {
      const divs = dividends[code] || [];
      const today = getTodayAU();
      
      let todayDiv = 0;
      let todayFranking = 0;
      
      for (const d of divs) {
        if (d.date === today) {
          const amount = d.amount * qty;
          todayDiv += amount;
          todayFranking += amount * (d.franking / 100) * (30 / 70);
        }
      }
      
      return { todayDiv, todayFranking };
    }

    function editDividendFranking(code, divIndex) {
      const div = dividends[code][divIndex];
      const newFranking = prompt(
        `Edit franking % for ${code} dividend on ${div.date}\nAmount: $${div.amount.toFixed(4)}\n\nEnter franking % (0-100):`,
        div.franking
      );
      
      if (newFranking === null) return;
      
      const frankingNum = parseFloat(newFranking);
      if (isNaN(frankingNum) || frankingNum < 0 || frankingNum > 100) {
        alert('Please enter a valid percentage between 0 and 100');
        return;
      }
      
      dividends[code][divIndex].franking = frankingNum;
      saveData();
      render();
    }

    /* ==========================================
       FORMATTING
       ========================================== */

    function fmt(num) {
      return new Intl.NumberFormat('en-AU', {
        style: 'currency',
        currency: 'AUD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function pct(num) {
      const sign = num >= 0 ? '+' : '';
      return `(${sign}${num.toFixed(2)}%)`;
    }

    /* ==========================================
       RENDERING
       ========================================== */

    function render() {
      if (portfolio.length === 0) {
        document.getElementById('portfolioSummary').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('stocks').innerHTML = '';
        updateMarketStatus();
        return;
      }
      
      document.getElementById('portfolioSummary').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
      
      renderPortfolio();
      renderStocks();
      updateMarketStatus();
    }

    function renderPortfolio() {
      let totalCost = 0;
      let totalValue = 0;
      let totalPrevValue = 0;
      let totalDivs = 0;
      let totalFranking = 0;
      let todayDivs = 0;
      let todayFranking = 0;
      
      for (const stock of portfolio) {
        const cost = stock.cost * stock.qty;
        const value = stock.currentPrice * stock.qty;
        const prevValue = stock.prevClose * stock.qty;
        
        totalCost += cost;
        totalValue += value;
        totalPrevValue += prevValue;
        
        const divs = calculateDividends(stock.code, stock.qty);
        totalDivs += divs.totalDiv;
        totalFranking += divs.totalFranking;
        
        const today = calculateTodaysDividends(stock.code, stock.qty);
        todayDivs += today.todayDiv;
        todayFranking += today.todayFranking;
      }
      
      document.getElementById('portfolioCostBase').textContent = fmt(totalCost);
      
      // Daily
      const dailyCapital = totalValue - totalPrevValue;
      const dailyCash = todayDivs + todayFranking;
      const dailyTotal = dailyCapital + dailyCash;
      const dailyPct = totalPrevValue > 0 ? (dailyTotal / totalPrevValue) * 100 : 0;
      
      document.getElementById('dailyTotal').textContent = fmt(dailyTotal);
      document.getElementById('dailyTotal').className = `metric-value ${dailyTotal >= 0 ? 'green' : 'red'}`;
      document.getElementById('dailyTotalPct').textContent = pct(dailyPct);
      document.getElementById('dailyTotalPct').className = `metric-pct ${dailyPct >= 0 ? 'green' : 'red'}`;
      
      document.getElementById('dailyCapital').textContent = fmt(dailyCapital);
      document.getElementById('dailyCapital').className = dailyCapital >= 0 ? 'green' : 'red';
      const dailyCapitalPct = totalPrevValue > 0 ? (dailyCapital / totalPrevValue) * 100 : 0;
      document.getElementById('dailyCapitalPct').textContent = pct(dailyCapitalPct);
      document.getElementById('dailyCapitalPct').className = `breakdown-pct ${dailyCapital >= 0 ? 'green' : 'red'}`;
      
      document.getElementById('dailyCash').textContent = fmt(dailyCash);
      const dailyCashPct = totalPrevValue > 0 ? (dailyCash / totalPrevValue) * 100 : 0;
      document.getElementById('dailyCashPct').textContent = dailyCash !== 0 ? pct(dailyCashPct) : '';
      
      document.getElementById('dailyDivs').textContent = fmt(todayDivs);
      const dailyDivsPct = totalPrevValue > 0 ? (todayDivs / totalPrevValue) * 100 : 0;
      document.getElementById('dailyDivsPct').textContent = todayDivs !== 0 ? pct(dailyDivsPct) : '';
      
      document.getElementById('dailyFrank').textContent = fmt(todayFranking);
      const dailyFrankPct = totalPrevValue > 0 ? (todayFranking / totalPrevValue) * 100 : 0;
      document.getElementById('dailyFrankPct').textContent = todayFranking !== 0 ? pct(dailyFrankPct) : '';
      
      // Life-to-date
      const ltdCapital = totalValue - totalCost;
      const ltdCash = totalDivs + totalFranking;
      const ltdTotal = ltdCapital + ltdCash;
      const ltdPct = totalCost > 0 ? (ltdTotal / totalCost) * 100 : 0;
      
      document.getElementById('ltdTotal').textContent = fmt(ltdTotal);
      document.getElementById('ltdTotal').className = `metric-value ${ltdTotal >= 0 ? 'green' : 'red'}`;
      document.getElementById('ltdTotalPct').textContent = pct(ltdPct);
      document.getElementById('ltdTotalPct').className = `metric-pct ${ltdPct >= 0 ? 'green' : 'red'}`;
      
      document.getElementById('ltdCapital').textContent = fmt(ltdCapital);
      document.getElementById('ltdCapital').className = ltdCapital >= 0 ? 'green' : 'red';
      const ltdCapitalPct = totalCost > 0 ? (ltdCapital / totalCost) * 100 : 0;
      document.getElementById('ltdCapitalPct').textContent = pct(ltdCapitalPct);
      document.getElementById('ltdCapitalPct').className = `breakdown-pct ${ltdCapital >= 0 ? 'green' : 'red'}`;
      
      document.getElementById('ltdCash').textContent = fmt(ltdCash);
      const ltdCashPct = totalCost > 0 ? (ltdCash / totalCost) * 100 : 0;
      document.getElementById('ltdCashPct').textContent = ltdCash !== 0 ? pct(ltdCashPct) : '';
      
      document.getElementById('ltdDivs').textContent = fmt(totalDivs);
      const ltdDivsPct = totalCost > 0 ? (totalDivs / totalCost) * 100 : 0;
      document.getElementById('ltdDivsPct').textContent = totalDivs !== 0 ? pct(ltdDivsPct) : '';
      
      document.getElementById('ltdFrank').textContent = fmt(totalFranking);
      const ltdFrankPct = totalCost > 0 ? (totalFranking / totalCost) * 100 : 0;
      document.getElementById('ltdFrankPct').textContent = totalFranking !== 0 ? pct(ltdFrankPct) : '';
    }

    function renderStocks() {
      let html = '';
      
      for (let i = 0; i < portfolio.length; i++) {
        const stock = portfolio[i];
        const cost = stock.cost * stock.qty;
        const value = stock.currentPrice * stock.qty;
        const prevValue = stock.prevClose * stock.qty;
        
        const dailyCapital = value - prevValue;
        const todayDivs = calculateTodaysDividends(stock.code, stock.qty);
        const dailyCash = todayDivs.todayDiv + todayDivs.todayFranking;
        const dailyTotal = dailyCapital + dailyCash;
        const dailyPct = prevValue > 0 ? (dailyTotal / prevValue) * 100 : 0;
        
        const divs = calculateDividends(stock.code, stock.qty);
        const ltdCapital = value - cost;
        const ltdCash = divs.totalDiv + divs.totalFranking;
        const ltdTotal = ltdCapital + ltdCash;
        const ltdPct = cost > 0 ? (ltdTotal / cost) * 100 : 0;
        
        const stockDivs = dividends[stock.code] || [];

        html += `
          <div class="stock">
            <div class="stock-header">
              <div>
                <div class="stock-code">${stock.code}</div>
                <div class="stock-qty">${stock.qty.toLocaleString()} @ ${fmt(stock.cost)}</div>
              </div>
              <div class="stock-current">
                <div class="stock-price-label">Current</div>
                <div class="stock-price-value">${stock.currentPrice > 0 ? fmt(stock.currentPrice) : '...'}</div>
              </div>
            </div>
            
            <div class="stock-cost-base">
              <span class="cost-base-label">Cost Base</span>
              <span class="cost-base-value">${fmt(cost)}</span>
            </div>
            
            <div class="two-column">
              <div class="column">
                <div class="column-title">Daily</div>
                
                <div class="metric">
                  <div class="metric-label">Change</div>
                  <div class="metric-value ${stock.currentPrice > 0 ? (dailyTotal >= 0 ? 'green' : 'red') : ''}">
                    ${stock.currentPrice > 0 ? fmt(dailyTotal) : '...'}
                  </div>
                  <div class="metric-pct ${stock.currentPrice > 0 ? (dailyPct >= 0 ? 'green' : 'red') : ''}">
                    ${stock.currentPrice > 0 ? pct(dailyPct) : ''}
                  </div>
                </div>
                
                <div class="breakdown">
                  <div class="breakdown-row">
                    <span class="breakdown-label">Capital</span>
                    <span class="breakdown-value">
                      <span class="${stock.currentPrice > 0 ? (dailyCapital >= 0 ? 'green' : 'red') : ''}">
                        ${stock.currentPrice > 0 ? fmt(dailyCapital) : '$0.00'}
                      </span>
                      <span class="breakdown-pct ${stock.currentPrice > 0 ? (dailyCapital >= 0 ? 'green' : 'red') : ''}">
                        ${stock.currentPrice > 0 && prevValue > 0 ? pct((dailyCapital / prevValue) * 100) : ''}
                      </span>
                    </span>
                  </div>
                  
                  <div class="breakdown-row">
                    <span class="breakdown-label">Cash</span>
                    <span class="breakdown-value blue">
                      <span>${fmt(dailyCash)}</span>
                      <span class="breakdown-pct">
                        ${stock.currentPrice > 0 && prevValue > 0 && dailyCash !== 0 ? pct((dailyCash / prevValue) * 100) : ''}
                      </span>
                    </span>
                  </div>
                  
                  <div class="sub-breakdown">
                    <div class="breakdown-row">
                      <span class="breakdown-label">Dividends</span>
                      <span class="breakdown-value blue">
                        <span>${fmt(todayDivs.todayDiv)}</span>
                        <span class="breakdown-pct">
                          ${stock.currentPrice > 0 && prevValue > 0 && todayDivs.todayDiv !== 0 ? pct((todayDivs.todayDiv / prevValue) * 100) : ''}
                        </span>
                      </span>
                    </div>
                    <div class="breakdown-row">
                      <span class="breakdown-label">Franking</span>
                      <span class="breakdown-value blue">
                        <span>${fmt(todayDivs.todayFranking)}</span>
                        <span class="breakdown-pct">
                          ${stock.currentPrice > 0 && prevValue > 0 && todayDivs.todayFranking !== 0 ? pct((todayDivs.todayFranking / prevValue) * 100) : ''}
                        </span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="column">
                <div class="column-title">Life-to-date</div>
                
                <div class="metric">
                  <div class="metric-label">Change</div>
                  <div class="metric-value ${stock.currentPrice > 0 ? (ltdTotal >= 0 ? 'green' : 'red') : ''}">
                    ${stock.currentPrice > 0 ? fmt(ltdTotal) : '...'}
                  </div>
                  <div class="metric-pct ${stock.currentPrice > 0 ? (ltdPct >= 0 ? 'green' : 'red') : ''}">
                    ${stock.currentPrice > 0 ? pct(ltdPct) : ''}
                  </div>
                </div>
                
                <div class="breakdown">
                  <div class="breakdown-row">
                    <span class="breakdown-label">Capital</span>
                    <span class="breakdown-value">
                      <span class="${stock.currentPrice > 0 ? (ltdCapital >= 0 ? 'green' : 'red') : ''}">
                        ${stock.currentPrice > 0 ? fmt(ltdCapital) : '$0.00'}
                      </span>
                      <span class="breakdown-pct ${stock.currentPrice > 0 ? (ltdCapital >= 0 ? 'green' : 'red') : ''}">
                        ${stock.currentPrice > 0 && cost > 0 ? pct((ltdCapital / cost) * 100) : ''}
                      </span>
                    </span>
                  </div>
                  
                  <div class="breakdown-row">
                    <span class="breakdown-label">Cash</span>
                    <span class="breakdown-value blue">
                      <span>${fmt(ltdCash)}</span>
                      <span class="breakdown-pct">
                        ${cost > 0 && ltdCash !== 0 ? pct((ltdCash / cost) * 100) : ''}
                      </span>
                    </span>
                  </div>
                  
                  <div class="sub-breakdown">
                    <div class="breakdown-row">
                      <span class="breakdown-label">Dividends</span>
                      <span class="breakdown-value blue">
                        <span>${fmt(divs.totalDiv)}</span>
                        <span class="breakdown-pct">
                          ${cost > 0 && divs.totalDiv !== 0 ? pct((divs.totalDiv / cost) * 100) : ''}
                        </span>
                      </span>
                    </div>
                    <div class="breakdown-row">
                      <span class="breakdown-label">Franking</span>
                      <span class="breakdown-value blue">
                        <span>${fmt(divs.totalFranking)}</span>
                        <span class="breakdown-pct">
                          ${cost > 0 && divs.totalFranking !== 0 ? pct((divs.totalFranking / cost) * 100) : ''}
                        </span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            ${stockDivs.length > 0 ? `
              <div class="dividend-list">
                ${stockDivs.map((d, idx) => `
                  <div class="dividend-item">
                    <span class="dividend-date">${d.date}</span>
                    <span>$${d.amount.toFixed(4)}</span>
                    <span class="dividend-franking" onclick="editDividendFranking('${stock.code}', ${idx})">${d.franking}% franked</span>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }
      
      document.getElementById('stocks').innerHTML = html;
    }

    /* ==========================================
       INITIALIZATION
       ========================================== */

    window.addEventListener('load', () => {
      loadData();
      render();
      updateMarketStatus();
      
      // Auto-refresh if zero prices and market open
      if (portfolio.length > 0 && isMarketOpen()) {
        const hasZeroPrices = portfolio.some(s => s.currentPrice === 0);
        if (hasZeroPrices) {
          setTimeout(() => updatePrices(), 1000);
        }
      }
      
      setInterval(updateMarketStatus, 60000);
    });
  </script>
</body>
</html>
