<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASX Portfolio Tracker</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#6366f1">
  
  <style>
    /* ==========================================
       BASE STYLES
       ========================================== */
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #e0f2fe 0%, #ddd6fe 100%);
      min-height: 100vh;
      padding: 16px;
    }
    
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
    }
    
    /* ==========================================
       CARDS
       ========================================== */
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* ==========================================
       HEADER & BUTTONS
       ========================================== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 16px;
    }
    
    h1 { 
      font-size: 24px; 
      color: #1f2937; 
      flex-shrink: 0; 
    }
    
    .header-buttons {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .btn {
      padding: 10px 18px;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-add { background: #8b5cf6; }
    .btn-latest { background: #6366f1; }
    .btn-divs { background: #10b981; }
    .btn-purge { background: #ef4444; }
    
    .btn-edit,
    .btn-delete { 
      color: white; 
      font-size: 13px; 
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .btn-edit { background: #6366f1; }
    .btn-delete { background: #dc2626; }
    
    /* ==========================================
       MARKET STATUS BADGE
       ========================================== */
    .market-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
    
    .market-open {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .market-closed {
      background: #fee2e2;
      color: #dc2626;
    }
    
    /* ==========================================
       DATA SOURCE NOTE
       ========================================== */
    .data-note {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 16px;
      font-size: 11px;
      color: #92400e;
      text-align: center;
    }
    
    /* ==========================================
       DIAGNOSTIC WINDOW
       ========================================== */
    .diagnostic {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 2000;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      display: none;
    }
    
    .diagnostic.active {
      display: block;
    }
    
    .diagnostic h3 {
      color: #1f2937;
      margin-bottom: 12px;
      font-size: 16px;
    }
    
    .diagnostic pre {
      background: #f3f4f6;
      padding: 12px;
      border-radius: 6px;
      font-size: 12px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .diagnostic-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1999;
      display: none;
    }
    
    .diagnostic-overlay.active {
      display: block;
    }
    
    /* ==========================================
       COST BASE DISPLAY
       ========================================== */
    .cost-base {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .cost-base-label {
      font-size: 14px;
      color: #6b7280;
      font-weight: 600;
    }
    
    .cost-base-value {
      font-size: 20px;
      font-weight: bold;
      color: #1f2937;
    }
    
    /* ==========================================
       TWO COLUMN LAYOUT
       ========================================== */
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .column {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
    }
    
    .column-title {
      font-size: 16px;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    /* ==========================================
       METRICS & PERCENTAGES
       ========================================== */
    .metric { 
      margin-bottom: 12px; 
    }
    
    .metric-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #1f2937;
    }
    
    .metric-pct {
      font-size: 14px;
      margin-top: 4px;
    }
    
    .green { color: #16a34a; }
    .red { color: #dc2626; }
    .blue { color: #2563eb; }
    
    /* ==========================================
       BREAKDOWN SECTIONS
       ========================================== */
    .breakdown {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    
    .breakdown-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      font-size: 12px;
      color: #6b7280;
    }
    
    .breakdown-label { 
      font-weight: 500; 
    }
    
    .breakdown-value {
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }
    
    .breakdown-pct {
      font-size: 11px;
      font-style: italic;
    }
    
    .sub-breakdown {
      margin-left: 16px;
      margin-top: 4px;
    }
    
    .sub-breakdown .breakdown-row {
      font-size: 11px;
      margin-bottom: 4px;
    }
    
    .sub-breakdown .breakdown-value {
      font-size: 11px;
    }
    
    .sub-breakdown .breakdown-pct {
      font-size: 10px;
    }
    
    /* ==========================================
       INDEX COMPARISON SECTION
       ========================================== */
    .index-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #d1d5db;
    }
    
    .index-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      font-size: 12px;
    }
    
    .index-label {
      color: #6b7280;
      font-weight: 500;
    }
    
    .index-value {
      font-weight: 600;
      font-size: 13px;
    }
    
    /* ==========================================
       STOCK CARDS
       ========================================== */
    .stock {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stock-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .stock-code { 
      font-size: 18px; 
      font-weight: bold; 
      color: #1f2937; 
    }
    
    .stock-qty { 
      font-size: 12px; 
      color: #6b7280; 
      margin-top: 4px; 
    }
    
    .stock-current { 
      text-align: right; 
    }
    
    .stock-price-label { 
      font-size: 11px; 
      color: #6b7280; 
      margin-bottom: 4px; 
    }
    
    .stock-price-value { 
      font-size: 16px; 
      font-weight: bold; 
      color: #1f2937; 
    }
    
    .stock-cost-base {
      background: #f9fafb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .stock-cost-base .cost-base-label { 
      font-size: 13px; 
    }
    
    .stock-cost-base .cost-base-value { 
      font-size: 16px; 
    }
    
    .stock-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    /* ==========================================
       DIVIDEND LIST
       ========================================== */
    .dividend-list {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .dividend-item {
      display: grid;
      grid-template-columns: auto auto 1fr;
      gap: 12px;
      align-items: center;
      font-size: 12px;
      color: #6b7280;
      padding: 6px 0;
    }
    
    .dividend-date { 
      color: #1f2937; 
      font-weight: 600; 
    }
    
    .dividend-franking {
      text-align: right;
      font-size: 11px;
      color: #6366f1;
      cursor: pointer;
      font-weight: 600;
    }
    
    .dividend-franking:hover { 
      text-decoration: underline; 
    }
    
    /* ==========================================
       EMPTY STATE
       ========================================== */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    
    .empty-state h2 {
      font-size: 18px;
      margin-bottom: 8px;
      color: #1f2937;
    }
    
    .empty-state p {
      font-size: 14px;
    }
    
    /* ==========================================
       STATUS TEXT
       ========================================== */
    .status {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
      text-align: center;
    }
    
    /* ==========================================
       MODAL
       ========================================== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active { 
      display: flex; 
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-content h2 {
      font-size: 20px;
      color: #1f2937;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }
    
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-buttons {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }
    
    .form-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn-save { 
      background: #6366f1; 
      color: white; 
    }
    
    .btn-cancel { 
      background: #e5e7eb; 
      color: #4b5563; 
    }
    
    /* ==========================================
       MOBILE RESPONSIVE
       ========================================== */
    @media (max-width: 640px) {
      body { padding: 12px; }
      .card { padding: 16px; }
      
      .header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      h1 {
        text-align: center;
        font-size: 22px;
      }
      
      .market-status {
        display: block;
        margin: 8px auto 0;
        font-size: 10px;
        padding: 3px 8px;
      }
      
      .header-buttons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }
      
      .btn {
        padding: 12px 8px;
        font-size: 13px;
        min-height: 44px;
      }
      
      .cost-base {
        padding: 12px;
      }
      
      .cost-base-label { font-size: 12px; }
      .cost-base-value { font-size: 18px; }
      
      .two-column {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .column {
        padding: 12px;
      }
      
      .column-title {
        font-size: 14px;
      }
      
      .metric-value { font-size: 16px; }
      .metric-pct { font-size: 12px; }
      
      .breakdown-row { font-size: 11px; }
      .breakdown-pct { font-size: 10px; }
      .sub-breakdown .breakdown-row { font-size: 10px; }
      .sub-breakdown .breakdown-pct { font-size: 9px; }
      
      .index-row { font-size: 11px; }
      .index-value { font-size: 12px; }
      
      #indexDailyData,
      #vsIndexDailyData,
      #indexLtdData,
      #vsIndexLtdData {
        font-size: 9px !important;
      }
      
      .stock { padding: 14px; }
      .stock-code { font-size: 16px; }
      .stock-qty { font-size: 11px; }
      .stock-price-value { font-size: 14px; }
      
      .stock-cost-base {
        padding: 10px;
      }
      
      .stock-cost-base .cost-base-value { font-size: 14px; }
      
      .dividend-item {
        font-size: 10px;
        gap: 8px;
      }
      
      .dividend-franking { font-size: 10px; }
      
      .stock-actions button {
        padding: 10px 12px;
        min-height: 40px;
      }
      
      .modal-content {
        width: 95%;
        max-width: 350px;
        padding: 20px;
      }
      
      .modal-content h2 { font-size: 18px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1>
          ASX Portfolio
          <span id="marketStatusBadge" class="market-status market-closed">Market Closed</span>
        </h1>
        <div class="header-buttons">
          <button class="btn btn-add" onclick="openAddModal()">Add</button>
          <button class="btn btn-latest" id="refreshBtn" onclick="refresh()">Latest</button>
          <button class="btn btn-divs" id="syncBtn" onclick="syncDividends()">Divs</button>
          <button class="btn btn-purge" onclick="clearDividends()">Purge</button>
        </div>
        <div style="margin-top: 8px; text-align: center;">
          <button class="btn" id="fixDataBtn" onclick="forceRefresh()" style="background: #f59e0b; font-size: 12px; padding: 8px 16px;">Fix Data</button>
        </div>
      </div>
      
      <div class="data-note">
        ðŸ“Š Prices from Yahoo Finance (indicative) â€¢ Verify with broker for tax reporting
      </div>
      
      <div id="portfolioSummary" style="display: none;">
        <div class="cost-base">
          <span class="cost-base-label">Cost Base</span>
          <span class="cost-base-value" id="portfolioCostBase">$0.00</span>
        </div>
        
        <div class="two-column">
          <div class="column">
            <div class="column-title">Daily</div>
            
            <div class="metric">
              <div class="metric-label">Total Change</div>
              <div class="metric-value" id="dailyTotal">$0.00</div>
              <div class="metric-pct" id="dailyTotalPct"></div>
            </div>
            
            <div class="breakdown">
              <div class="breakdown-row">
                <span class="breakdown-label">Capital</span>
                <span class="breakdown-value">
                  <span id="dailyCapital">$0.00</span>
                  <span class="breakdown-pct" id="dailyCapitalPct"></span>
                </span>
              </div>
              
              <div class="breakdown-row">
                <span class="breakdown-label">Cash</span>
                <span class="breakdown-value blue">
                  <span id="dailyCash">$0.00</span>
                  <span class="breakdown-pct" id="dailyCashPct"></span>
                </span>
              </div>
              
              <div class="sub-breakdown">
                <div class="breakdown-row">
                  <span class="breakdown-label">Dividends</span>
                  <span class="breakdown-value blue">
                    <span id="dailyDivs">$0.00</span>
                    <span class="breakdown-pct" id="dailyDivsPct"></span>
                  </span>
                </div>
                <div class="breakdown-row">
                  <span class="breakdown-label">Franking</span>
                  <span class="breakdown-value blue">
                    <span id="dailyFrank">$0.00</span>
                    <span class="breakdown-pct" id="dailyFrankPct"></span>
                  </span>
                </div>
              </div>
            </div>
            
            <div class="index-section">
              <div class="index-row">
                <span class="index-label">ASX 200</span>
                <span class="index-value" id="indexDaily">...</span>
              </div>
              <div class="index-row" style="font-size: 10px; color: #9ca3af; margin-top: -2px;">
                <span id="indexDailyData">...</span>
              </div>
              <div class="index-row" style="margin-top: 8px;">
                <span class="index-label">vs ASX 200</span>
                <span class="index-value" id="vsIndexDaily">...</span>
              </div>
              <div class="index-row" style="font-size: 10px; color: #9ca3af; margin-top: -2px;">
                <span id="vsIndexDailyData">...</span>
              </div>
            </div>
          </div>
          
          <div class="column">
            <div class="column-title">Life-to-date</div>
            
            <div class="metric">
              <div class="metric-label">Total Change</div>
              <div class="metric-value" id="ltdTotal">$0.00</div>
              <div class="metric-pct" id="ltdTotalPct"></div>
            </div>
            
            <div class="breakdown">
              <div class="breakdown-row">
                <span class="breakdown-label">Capital</span>
                <span class="breakdown-value">
                  <span id="ltdCapital">$0.00</span>
                  <span class="breakdown-pct" id="ltdCapitalPct"></span>
                </span>
              </div>
              
              <div class="breakdown-row">
                <span class="breakdown-label">Cash</span>
                <span class="breakdown-value blue">
                  <span id="ltdCash">$0.00</span>
                  <span class="breakdown-pct" id="ltdCashPct"></span>
                </span>
              </div>
              
              <div class="sub-breakdown">
                <div class="breakdown-row">
                  <span class="breakdown-label">Dividends</span>
                  <span class="breakdown-value blue">
                    <span id="ltdDivs">$0.00</span>
                    <span class="breakdown-pct" id="ltdDivsPct"></span>
                  </span>
                </div>
                <div class="breakdown-row">
                  <span class="breakdown-label">Franking</span>
                  <span class="breakdown-value blue">
                    <span id="ltdFrank">$0.00</span>
                    <span class="breakdown-pct" id="ltdFrankPct"></span>
                  </span>
                </div>
              </div>
            </div>
            
            <div class="index-section">
              <div class="index-row">
                <span class="index-label">ASX 200</span>
                <span class="index-value" id="indexLtd">...</span>
              </div>
              <div class="index-row" style="font-size: 10px; color: #9ca3af; margin-top: -2px;">
                <span id="indexLtdData">...</span>
              </div>
              <div class="index-row" style="margin-top: 8px;">
                <span class="index-label">vs ASX 200</span>
                <span class="index-value" id="vsIndexLtd">...</span>
              </div>
              <div class="index-row" style="font-size: 10px; color: #9ca3af; margin-top: -2px;">
                <span id="vsIndexLtdData">...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="status" id="status"></div>
    </div>
    
    <div id="stocks"></div>
    
    <div id="emptyState" class="card empty-state">
      <h2>No Stocks Yet</h2>
      <p>Click "Add" to start building your portfolio</p>
    </div>
  </div>

  <div id="stockModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Add Stock</h2>
      <div class="form-group">
        <label>ASX Code</label>
        <input type="text" id="stockCode" placeholder="e.g. WOW" style="text-transform: uppercase;">
      </div>
      <div class="form-group">
        <label>Quantity</label>
        <input type="number" id="stockQty" placeholder="e.g. 1000">
      </div>
      <div class="form-group">
        <label>Cost Per Share ($)</label>
        <input type="number" step="0.000001" id="stockCost" placeholder="e.g. 28.50">
      </div>
      <div class="form-buttons">
        <button class="btn-cancel" onclick="closeStockModal()">Cancel</button>
        <button class="btn-save" onclick="saveStock()">Save</button>
      </div>
    </div>
  </div>

  <div class="diagnostic-overlay" id="diagnosticOverlay"></div>
  <div class="diagnostic" id="diagnosticWindow">
    <h3>ðŸ“Š Yahoo Finance Raw Data (ASX 200)</h3>
    <pre id="diagnosticContent"></pre>
  </div>

  <script>
    /* ==========================================
       GLOBAL STATE
       ========================================== */
    let portfolio = [];
    let dividends = {};
    let indexData = {
      currentPrice: 0,
      prevClose: 0,
      startPrice: 8830.90,  // ASX 200 close on 2025-11-10
      startDate: "2025-11-10"
    };
    let editingIndex = -1;

    /* ==========================================
       DATE & TIME UTILITIES (Australia/Sydney)
       ========================================== */
    
    function getTodayAU() {
      const now = new Date();
      const auNow = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
      const year = auNow.getFullYear();
      const month = String(auNow.getMonth() + 1).padStart(2, '0');
      const day = String(auNow.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function isMarketOpen() {
      const now = new Date();
      const auNow = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
      
      const day = auNow.getDay();
      const hour = auNow.getHours();
      const minute = auNow.getMinutes();
      
      // Weekend check
      if (day === 0 || day === 6) return false;
      
      // Trading hours: 10:00 AM - 4:30 PM AEST/AEDT
      const timeInMinutes = hour * 60 + minute;
      const marketOpen = 10 * 60;
      const marketClose = 16 * 60 + 30;
      
      return timeInMinutes >= marketOpen && timeInMinutes < marketClose;
    }

    function getMarketStatusText() {
      const now = new Date();
      const auNow = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
      const day = auNow.getDay();
      const hour = auNow.getHours();
      const minute = auNow.getMinutes();
      
      if (day === 0 || day === 6) {
        return 'Market Closed (Weekend)';
      }
      
      const timeInMinutes = hour * 60 + minute;
      const marketOpen = 10 * 60;
      const marketClose = 16 * 60 + 30;
      
      if (timeInMinutes < marketOpen) {
        const minsUntilOpen = marketOpen - timeInMinutes;
        const hoursUntil = Math.floor(minsUntilOpen / 60);
        const minsUntil = minsUntilOpen % 60;
        return `Opens in ${hoursUntil}h ${minsUntil}m`;
      } else if (timeInMinutes >= marketClose) {
        return 'Market Closed';
      } else {
        return 'Market Open';
      }
    }

    /* ==========================================
       DATA PERSISTENCE (localStorage)
       ========================================== */

    function loadData() {
      const saved = localStorage.getItem('asx-portfolio-simple');
      if (saved) {
        portfolio = JSON.parse(saved);
      } else {
        // Migration from old formats
        const v2 = localStorage.getItem('asx-portfolio-v2');
        const v1 = localStorage.getItem('asx-portfolio');
        
        if (v2) {
          const oldPortfolio = JSON.parse(v2);
          portfolio = oldPortfolio.map(stock => ({
            code: stock.code,
            qty: stock.qty,
            cost: stock.cost,
            currentPrice: stock.currentPrice || 0,
            prevClose: 0
          }));
          console.log('Migrated from v2');
        } else if (v1) {
          const oldPortfolio = JSON.parse(v1);
          portfolio = oldPortfolio.map(stock => ({
            code: stock.code,
            qty: stock.qty,
            cost: stock.cost,
            currentPrice: stock.price || 0,
            prevClose: 0
          }));
          console.log('Migrated from v1');
        }
      }
      
      const savedDivs = localStorage.getItem('asx-dividends');
      dividends = savedDivs ? JSON.parse(savedDivs) : {};
      
      const savedIndex = localStorage.getItem('asx-index-simple');
      if (savedIndex) {
        indexData = JSON.parse(savedIndex);
      }
    }

    function saveData() {
      localStorage.setItem('asx-portfolio-simple', JSON.stringify(portfolio));
      localStorage.setItem('asx-dividends', JSON.stringify(dividends));
      localStorage.setItem('asx-index-simple', JSON.stringify(indexData));
    }

    /* ==========================================
       PRICE FETCHING (Yahoo Finance)
       Simple: Just get current and previous close
       ========================================== */

    function showDiagnostic(data) {
      const overlay = document.getElementById('diagnosticOverlay');
      const window = document.getElementById('diagnosticWindow');
      const content = document.getElementById('diagnosticContent');
      
      overlay.classList.add('active');
      window.classList.add('active');
      content.textContent = data;
      
      // Auto-hide after 10 seconds
      setTimeout(() => {
        overlay.classList.remove('active');
        window.classList.remove('active');
      }, 10000);
    }

    async function fetchPrice(code) {
      try {
        const timestamp = Date.now();
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${code}.AX?interval=1d&range=5d&_=${timestamp}`;
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
        
        const res = await fetch(proxyUrl, { cache: 'no-store' });
        if (!res.ok) return null;
        
        const data = await res.json();
        const result = data?.chart?.result?.[0];
        const meta = result?.meta;
        
        if (!meta) return null;
        
        const currentPrice = meta.regularMarketPrice;
        if (!currentPrice) return null;
        
        // Parse actual close prices with timestamps
        const closes = result?.indicators?.quote?.[0]?.close;
        const timestamps = result?.timestamp;
        
        if (!closes || !timestamps || closes.length < 2) {
          // Fallback to meta.previousClose if we can't parse array
          const prevClose = meta.previousClose || meta.chartPreviousClose;
          return prevClose ? { currentPrice, prevClose } : null;
        }
        
        // Build array of [date, close] pairs
        const dailyData = [];
        for (let i = 0; i < timestamps.length; i++) {
          if (closes[i] !== null) {
            const utcDate = new Date(timestamps[i] * 1000);
            const auDate = new Date(utcDate.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
            const year = auDate.getFullYear();
            const month = String(auDate.getMonth() + 1).padStart(2, '0');
            const day = String(auDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            dailyData.push({ date: dateStr, close: closes[i] });
          }
        }
        
        // Sort by date descending
        dailyData.sort((a, b) => b.date.localeCompare(a.date));
        
        // Get yesterday's close (most recent close before today)
        const today = getTodayAU();
        const prevDayData = dailyData.find(d => d.date < today);
        
        if (!prevDayData) {
          // Fallback
          const prevClose = meta.previousClose || meta.chartPreviousClose;
          return prevClose ? { currentPrice, prevClose } : null;
        }
        
        return {
          currentPrice,
          prevClose: prevDayData.close
        };
      } catch (e) {
        console.error(`${code}:`, e);
        return null;
      }
    }

    async function fetchIndexData() {
      try {
        const timestamp = Date.now();
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/%5EAXJO?interval=1d&range=5d&_=${timestamp}`;
        const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, { cache: 'no-store' });
        
        if (!res.ok) return;
        
        const data = await res.json();
        const result = data?.chart?.result?.[0];
        const meta = result?.meta;
        
        if (!meta) return;
        
        const currentPrice = meta.regularMarketPrice;
        if (!currentPrice) return;
        
        // Build diagnostic output
        let diagnostic = '=== META DATA ===\n';
        diagnostic += `regularMarketPrice: ${meta.regularMarketPrice}\n`;
        diagnostic += `previousClose: ${meta.previousClose || 'N/A'}\n`;
        diagnostic += `chartPreviousClose: ${meta.chartPreviousClose || 'N/A'}\n\n`;
        
        // Parse actual close prices with timestamps
        const closes = result?.indicators?.quote?.[0]?.close;
        const timestamps = result?.timestamp;
        
        diagnostic += '=== CLOSES ARRAY (AU Timezone) ===\n';
        
        if (!closes || !timestamps || closes.length < 2) {
          diagnostic += 'No close data available\n';
          
          // Fallback to meta.previousClose
          const prevClose = meta.previousClose || meta.chartPreviousClose;
          if (prevClose) {
            indexData.currentPrice = currentPrice;
            indexData.prevClose = prevClose;
            diagnostic += `\nUsing meta.previousClose: ${prevClose}\n`;
          }
          
          showDiagnostic(diagnostic);
          return;
        }
        
        // Build array of [date, close] pairs
        const dailyData = [];
        for (let i = 0; i < timestamps.length; i++) {
          if (closes[i] !== null) {
            const utcDate = new Date(timestamps[i] * 1000);
            const auDate = new Date(utcDate.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
            const year = auDate.getFullYear();
            const month = String(auDate.getMonth() + 1).padStart(2, '0');
            const day = String(auDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            dailyData.push({ date: dateStr, close: closes[i] });
            diagnostic += `${dateStr}: ${closes[i].toFixed(2)}\n`;
          }
        }
        
        // Sort by date descending
        dailyData.sort((a, b) => b.date.localeCompare(a.date));
        
        // Get yesterday's close (most recent close before today)
        const today = getTodayAU();
        const prevDayData = dailyData.find(d => d.date < today);
        
        diagnostic += `\n=== ANALYSIS ===\n`;
        diagnostic += `Today (AU): ${today}\n`;
        
        if (!prevDayData) {
          diagnostic += 'No previous day data found\n';
          
          // Fallback
          const prevClose = meta.previousClose || meta.chartPreviousClose;
          if (prevClose) {
            indexData.currentPrice = currentPrice;
            indexData.prevClose = prevClose;
            diagnostic += `Using meta.previousClose: ${prevClose}\n`;
          }
          
          showDiagnostic(diagnostic);
          return;
        }
        
        diagnostic += `Previous day found: ${prevDayData.date} = ${prevDayData.close.toFixed(2)}\n`;
        diagnostic += `\n=== FINAL VALUES ===\n`;
        diagnostic += `currentPrice: ${currentPrice}\n`;
        diagnostic += `prevClose (from array): ${prevDayData.close.toFixed(2)}\n`;
        diagnostic += `prevClose (from meta): ${meta.previousClose}\n`;
        
        const diff = Math.abs(prevDayData.close - meta.previousClose);
        diagnostic += `Difference: ${diff.toFixed(2)} points\n`;
        
        if (diff > 50) {
          diagnostic += '\nâš ï¸ LARGE DIFFERENCE - Using array value!\n';
        }
        
        indexData.currentPrice = currentPrice;
        indexData.prevClose = prevDayData.close;
        
        showDiagnostic(diagnostic);
      } catch (e) {
        console.error('ASX 200:', e);
        showDiagnostic(`ERROR: ${e.message}`);
      }
    }

    /* ==========================================
       PRICE UPDATE
       ========================================== */

    async function updatePrices() {
      if (portfolio.length === 0) return;
      
      if (!isMarketOpen()) {
        const status = document.getElementById('status');
        status.textContent = 'Market closed - refresh during trading hours (10 AM - 4:30 PM)';
        status.style.color = '#dc2626';
        setTimeout(() => {
          status.textContent = '';
        }, 3000);
        return;
      }
      
      const btn = document.getElementById('refreshBtn');
      const status = document.getElementById('status');
      
      btn.textContent = '...';
      btn.disabled = true;
      
      const start = Date.now();
      
      const promises = portfolio.map(async (stock) => {
        const data = await fetchPrice(stock.code);
        if (!data) return false;
        
        stock.currentPrice = data.currentPrice;
        stock.prevClose = data.prevClose;
        
        return true;
      });
      
      const results = await Promise.all(promises);
      const success = results.filter(r => r).length;
      
      await fetchIndexData();
      
      saveData();
      render();
      
      const elapsed = ((Date.now() - start) / 1000).toFixed(1);
      
      btn.textContent = 'Latest';
      btn.disabled = false;
      
      if (success === portfolio.length) {
        status.textContent = `âœ“ ${elapsed}s`;
        status.style.color = '#16a34a';
        
        setTimeout(() => {
          status.textContent = '';
        }, 3000);
      } else {
        status.textContent = `âš ï¸ ${success}/${portfolio.length}`;
        status.style.color = '#dc2626';
      }
    }

    function refresh() {
      updatePrices();
    }

    /* ==========================================
       MARKET STATUS UI
       ========================================== */

    function updateMarketStatus() {
      const btn = document.getElementById('refreshBtn');
      const badge = document.getElementById('marketStatusBadge');
      const marketOpen = isMarketOpen();
      
      if (!marketOpen) {
        btn.disabled = true;
        btn.title = 'Market closed - refresh available 10 AM - 4:30 PM';
      } else {
        if (portfolio.length > 0) {
          btn.disabled = false;
        }
        btn.title = 'Refresh prices';
      }
      
      if (marketOpen) {
        badge.textContent = 'Market Open';
        badge.className = 'market-status market-open';
      } else {
        badge.textContent = getMarketStatusText();
        badge.className = 'market-status market-closed';
      }
    }

    /* ==========================================
       DIVIDENDS
       ========================================== */

    async function fetchDividends(code) {
      try {
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${code}.AX?interval=1mo&range=1y&events=div`;
        const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
        
        if (!res.ok) return [];
        
        const data = await res.json();
        const events = data?.chart?.result?.[0]?.events?.dividends;
        if (!events) return [];
        
        const startDateStr = '2025-11-10';
        
        return Object.values(events)
          .map(d => {
            const utcDate = new Date(d.date * 1000);
            const auDate = new Date(utcDate.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
            
            const year = auDate.getFullYear();
            const month = String(auDate.getMonth() + 1).padStart(2, '0');
            const day = String(auDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            return {
              dateStr: dateStr,
              amount: d.amount
            };
          })
          .filter(d => d.dateStr >= startDateStr);
      } catch (e) {
        return [];
      }
    }

    async function syncDividends() {
      if (portfolio.length === 0) return;
      
      const btn = document.getElementById('syncBtn');
      const status = document.getElementById('status');
      
      btn.textContent = '...';
      btn.disabled = true;
      
      let newCount = 0;
      
      for (const stock of portfolio) {
        const apiDivs = await fetchDividends(stock.code);
        
        if (!dividends[stock.code]) dividends[stock.code] = [];
        
        for (const apiDiv of apiDivs) {
          const dateStr = apiDiv.dateStr;
          const exists = dividends[stock.code].some(d => d.date === dateStr);
          
          if (!exists) {
            dividends[stock.code].push({
              date: dateStr,
              amount: apiDiv.amount,
              franking: 100
            });
            newCount++;
          }
        }
        
        dividends[stock.code].sort((a, b) => new Date(b.date) - new Date(a.date));
      }
      
      saveData();
      render();
      
      btn.textContent = 'Divs';
      btn.disabled = false;
      
      status.textContent = newCount > 0 ? `âœ“ +${newCount}` : `âœ“`;
      status.style.color = '#16a34a';
      setTimeout(() => status.textContent = '', 3000);
    }

    function clearDividends() {
      if (!confirm('Clear all dividend data?\n\nYou can re-sync afterwards.')) {
        return;
      }
      
      dividends = {};
      saveData();
      render();
      
      const status = document.getElementById('status');
      status.textContent = 'âœ“ Cleared';
      status.style.color = '#16a34a';
      setTimeout(() => status.textContent = '', 3000);
    }

    function calculateDividends(code, qty) {
      const divs = dividends[code] || [];
      let totalDiv = 0;
      let totalFranking = 0;
      
      for (const d of divs) {
        const amount = d.amount * qty;
        totalDiv += amount;
        totalFranking += amount * (d.franking / 100) * (30 / 70);
      }
      
      return { totalDiv, totalFranking };
    }

    function calculateTodaysDividends(code, qty) {
      const divs = dividends[code] || [];
      const today = getTodayAU();
      
      let todayDiv = 0;
      let todayFranking = 0;
      
      for (const d of divs) {
        if (d.date === today) {
          const amount = d.amount * qty;
          todayDiv += amount;
          todayFranking += amount * (d.franking / 100) * (30 / 70);
        }
      }
      
      return { todayDiv, todayFranking };
    }

    /* ==========================================
       STOCK MANAGEMENT (Modal)
       ========================================== */

    function openAddModal() {
      editingIndex = -1;
      document.getElementById('modalTitle').textContent = 'Add Stock';
      document.getElementById('stockCode').value = '';
      document.getElementById('stockCode').disabled = false;
      document.getElementById('stockQty').value = '';
      document.getElementById('stockCost').value = '';
      document.getElementById('stockModal').classList.add('active');
    }

    function openEditModal(index) {
      editingIndex = index;
      const stock = portfolio[index];
      document.getElementById('modalTitle').textContent = 'Edit Stock';
      document.getElementById('stockCode').value = stock.code;
      document.getElementById('stockCode').disabled = true;
      document.getElementById('stockQty').value = stock.qty;
      document.getElementById('stockCost').value = stock.cost;
      document.getElementById('stockModal').classList.add('active');
    }

    function closeStockModal() {
      document.getElementById('stockModal').classList.remove('active');
    }

    function saveStock() {
      const code = document.getElementById('stockCode').value.toUpperCase().trim();
      const qty = parseInt(document.getElementById('stockQty').value);
      const cost = parseFloat(document.getElementById('stockCost').value);
      
      if (!code || !qty || !cost || qty <= 0 || cost <= 0) {
        alert('Please fill in all fields with valid values');
        return;
      }
      
      if (editingIndex === -1) {
        const exists = portfolio.some(s => s.code === code);
        if (exists) {
          alert(`${code} is already in your portfolio`);
          return;
        }
        
        portfolio.push({
          code: code,
          qty: qty,
          cost: cost,
          currentPrice: 0,
          prevClose: 0
        });
      } else {
        portfolio[editingIndex].qty = qty;
        portfolio[editingIndex].cost = cost;
      }
      
      saveData();
      closeStockModal();
      render();
      
      if (portfolio.length === 1 && isMarketOpen()) {
        updatePrices();
      }
    }

    function deleteStock(index) {
      const stock = portfolio[index];
      if (confirm(`Delete ${stock.code} from portfolio?`)) {
        portfolio.splice(index, 1);
        delete dividends[stock.code];
        saveData();
        render();
      }
    }

    function editDividendFranking(code, divIndex) {
      const div = dividends[code][divIndex];
      const newFranking = prompt(
        `Edit franking % for ${code} dividend on ${div.date}\nAmount: $${div.amount.toFixed(4)}\n\nEnter franking % (0-100):`,
        div.franking
      );
      
      if (newFranking === null) return;
      
      const frankingNum = parseFloat(newFranking);
      if (isNaN(frankingNum) || frankingNum < 0 || frankingNum > 100) {
        alert('Please enter a valid percentage between 0 and 100');
        return;
      }
      
      dividends[code][divIndex].franking = frankingNum;
      saveData();
      render();
    }

    /* ==========================================
       FORMATTING HELPERS
       ========================================== */

    function fmt(num) {
      return new Intl.NumberFormat('en-AU', {
        style: 'currency',
        currency: 'AUD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num);
    }

    function pct(num) {
      const sign = num >= 0 ? '+' : '';
      return `(${sign}${num.toFixed(2)}%)`;
    }

    /* ==========================================
       RENDERING
       ========================================== */

    function render() {
      if (portfolio.length === 0) {
        document.getElementById('portfolioSummary').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('stocks').innerHTML = '';
        updateMarketStatus();
        return;
      }
      
      document.getElementById('portfolioSummary').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
      
      renderPortfolio();
      renderStocks();
      updateMarketStatus();
    }

    function renderPortfolio() {
      let totalCost = 0;
      let totalValue = 0;
      let totalPrevValue = 0;
      let totalDivs = 0;
      let totalFranking = 0;
      let todayDivs = 0;
      let todayFranking = 0;
      
      for (const stock of portfolio) {
        const cost = stock.cost * stock.qty;
        const value = stock.currentPrice * stock.qty;
        const prevValue = stock.prevClose * stock.qty;
        
        totalCost += cost;
        totalValue += value;
        totalPrevValue += prevValue;
        
        const divs = calculateDividends(stock.code, stock.qty);
        totalDivs += divs.totalDiv;
        totalFranking += divs.totalFranking;
        
        const today = calculateTodaysDividends(stock.code, stock.qty);
        todayDivs += today.todayDiv;
        todayFranking += today.todayFranking;
      }
      
      document.getElementById('portfolioCostBase').textContent = fmt(totalCost);
      
      // Daily calculations
      const dailyCapital = totalValue - totalPrevValue;
      const dailyCash = todayDivs + todayFranking;
      const dailyTotal = dailyCapital + dailyCash;
      const dailyPct = totalPrevValue > 0 ? (dailyTotal / totalPrevValue) * 100 : 0;
      
      document.getElementById('dailyTotal').textContent = fmt(dailyTotal);
      document.getElementById('dailyTotal').className = `metric-value ${dailyTotal >= 0 ? 'green' : 'red'}`;
      document.getElementById('dailyTotalPct').textContent = pct(dailyPct);
      document.getElementById('dailyTotalPct').className = `metric-pct ${dailyPct >= 0 ? 'green' : 'red'}`;
      
      document.getElementById('dailyCapital').textContent = fmt(dailyCapital);
      document.getElementById('dailyCapital').className = dailyCapital >= 0 ? 'green' : 'red';
      const dailyCapitalPct = totalPrevValue > 0 ? (dailyCapital / totalPrevValue) * 100 : 0;
      document.getElementById('dailyCapitalPct').textContent = pct(dailyCapitalPct);
      document.getElementById('dailyCapitalPct').className = `breakdown-pct ${dailyCapital >= 0 ? 'green' : 'red'}`;
      
      document.getElementById('dailyCash').textContent = fmt(dailyCash);
      const dailyCashPct = totalPrevValue > 0 ? (dailyCash / totalPrevValue) * 100 : 0;
      document.getElementById('dailyCashPct').textContent = dailyCash !== 0 ? pct(dailyCashPct) : '';
      
      document.getElementById('dailyDivs').textContent = fmt(todayDivs);
      const dailyDivsPct = totalPrevValue > 0 ? (todayDivs / totalPrevValue) * 100 : 0;
      document.getElementById('dailyDivsPct').textContent = todayDivs !== 0 ? pct(dailyDivsPct) : '';
      
      document.getElementById('dailyFrank').textContent = fmt(todayFranking);
      const dailyFrankPct = totalPrevValue > 0 ? (todayFranking / totalPrevValue) * 100 : 0;
      document.getElementById('dailyFrankPct').textContent = todayFranking !== 0 ? pct(dailyFrankPct) : '';
      
      // Life-to-date calculations
      const ltdCapital = totalValue - totalCost;
      const ltdCash = totalDivs + totalFranking;
      const ltdTotal = ltdCapital + ltdCash;
      const ltdPct = totalCost > 0 ? (ltdTotal / totalCost) * 100 : 0;
      
      document.getElementById('ltdTotal').textContent = fmt(ltdTotal);
      document.getElementById('ltdTotal').className = `metric-value ${ltdTotal >= 0 ? 'green' : 'red'}`;
      document.getElementById('ltdTotalPct').textContent = pct(ltdPct);
      document.getElementById('ltdTotalPct').className = `metric-pct ${ltdPct >= 0 ? 'green' : 'red'}`;
      
      document.getElementById('ltdCapital').textContent = fmt(ltdCapital);
      document.getElementById('ltdCapital').className = ltdCapital >= 0 ? 'green' : 'red';
      const ltdCapitalPct = totalCost > 0 ? (ltdCapital / totalCost) * 100 : 0;
      document.getElementById('ltdCapitalPct').textContent = pct(ltdCapitalPct);
      document.getElementById('ltdCapitalPct').className = `breakdown-pct ${ltdCapital >= 0 ? 'green' : 'red'}`;
      
      document.getElementById('ltdCash').textContent = fmt(ltdCash);
      const ltdCashPct = totalCost > 0 ? (ltdCash / totalCost) * 100 : 0;
      document.getElementById('ltdCashPct').textContent = ltdCash !== 0 ? pct(ltdCashPct) : '';
      
      document.getElementById('ltdDivs').textContent = fmt(totalDivs);
      const ltdDivsPct = totalCost > 0 ? (totalDivs / totalCost) * 100 : 0;
      document.getElementById('ltdDivsPct').textContent = totalDivs !== 0 ? pct(ltdDivsPct) : '';
      
      document.getElementById('ltdFrank').textContent = fmt(totalFranking);
      const ltdFrankPct = totalCost > 0 ? (totalFranking / totalCost) * 100 : 0;
      document.getElementById('ltdFrankPct').textContent = totalFranking !== 0 ? pct(ltdFrankPct) : '';
      
      // Index comparison - Daily
      const indexCurrent = indexData.currentPrice;
      const indexPrev = indexData.prevClose;
      
      if (indexCurrent > 0 && indexPrev > 0) {
        const indexDailyChange = ((indexCurrent - indexPrev) / indexPrev) * 100;
        const vsIndexDaily = dailyPct - indexDailyChange;
        
        document.getElementById('indexDaily').textContent = pct(indexDailyChange);
        document.getElementById('indexDaily').className = `index-value ${indexDailyChange >= 0 ? 'green' : 'red'}`;
        document.getElementById('indexDailyData').textContent = `${indexCurrent.toFixed(2)} vs ${indexPrev.toFixed(2)}`;
        
        document.getElementById('vsIndexDaily').textContent = pct(vsIndexDaily);
        document.getElementById('vsIndexDaily').className = `index-value ${vsIndexDaily >= 0 ? 'green' : 'red'}`;
        document.getElementById('vsIndexDailyData').textContent = `Port ${dailyPct >= 0 ? '+' : ''}${dailyPct.toFixed(2)}% vs Index ${indexDailyChange >= 0 ? '+' : ''}${indexDailyChange.toFixed(2)}%`;
      } else {
        document.getElementById('indexDaily').textContent = '...';
        document.getElementById('indexDaily').className = 'index-value';
        document.getElementById('indexDailyData').textContent = '';
        document.getElementById('vsIndexDaily').textContent = '...';
        document.getElementById('vsIndexDaily').className = 'index-value';
        document.getElementById('vsIndexDailyData').textContent = '';
      }
      
      // Index comparison - Life-to-date
      if (indexCurrent > 0 && totalCost > 0) {
        const indexLtdChange = ((indexCurrent - indexData.startPrice) / indexData.startPrice) * 100;
        const vsIndexLtd = ltdPct - indexLtdChange;
        
        document.getElementById('indexLtd').textContent = pct(indexLtdChange);
        document.getElementById('indexLtd').className = `index-value ${indexLtdChange >= 0 ? 'green' : 'red'}`;
        document.getElementById('indexLtdData').textContent = `${indexCurrent.toFixed(2)} vs ${indexData.startPrice.toFixed(2)}`;
        
        document.getElementById('vsIndexLtd').textContent = pct(vsIndexLtd);
        document.getElementById('vsIndexLtd').className = `index-value ${vsIndexLtd >= 0 ? 'green' : 'red'}`;
        document.getElementById('vsIndexLtdData').textContent = `Port ${ltdPct >= 0 ? '+' : ''}${ltdPct.toFixed(2)}% vs Index ${indexLtdChange >= 0 ? '+' : ''}${indexLtdChange.toFixed(2)}%`;
      } else {
        document.getElementById('indexLtd').textContent = '...';
        document.getElementById('indexLtd').className = 'index-value';
        document.getElementById('indexLtdData').textContent = '';
        document.getElementById('vsIndexLtd').textContent = '...';
        document.getElementById('vsIndexLtd').className = 'index-value';
        document.getElementById('vsIndexLtdData').textContent = '';
      }
    }

    function renderStocks() {
      let html = '';
      
      for (let i = 0; i < portfolio.length; i++) {
        const stock = portfolio[i];
        const cost = stock.cost * stock.qty;
        const value = stock.currentPrice * stock.qty;
        const prevValue = stock.prevClose * stock.qty;
        
        const dailyCapital = value - prevValue;
        const todayDivs = calculateTodaysDividends(stock.code, stock.qty);
        const dailyCash = todayDivs.todayDiv + todayDivs.todayFranking;
        const dailyTotal = dailyCapital + dailyCash;
        const dailyPct = prevValue > 0 ? (dailyTotal / prevValue) * 100 : 0;
        
        const divs = calculateDividends(stock.code, stock.qty);
        const ltdCapital = value - cost;
        const ltdCash = divs.totalDiv + divs.totalFranking;
        const ltdTotal = ltdCapital + ltdCash;
        const ltdPct = cost > 0 ? (ltdTotal / cost) * 100 : 0;
        
        const stockDivs = dividends[stock.code] || [];

        html += `
          <div class="stock">
            <div class="stock-header">
              <div>
                <div class="stock-code">${stock.code}</div>
                <div class="stock-qty">${stock.qty.toLocaleString()} @ ${fmt(stock.cost)}</div>
              </div>
              <div class="stock-current">
                <div class="stock-price-label">Current</div>
                <div class="stock-price-value">${stock.currentPrice > 0 ? fmt(stock.currentPrice) : '...'}</div>
              </div>
            </div>
            
            <div class="stock-cost-base">
              <span class="cost-base-label">Cost Base</span>
              <span class="cost-base-value">${fmt(cost)}</span>
            </div>
            
            <div class="two-column">
              <div class="column">
                <div class="column-title">Daily</div>
                
                <div class="metric">
                  <div class="metric-label">Change</div>
                  <div class="metric-value ${stock.currentPrice > 0 ? (dailyTotal >= 0 ? 'green' : 'red') : ''}">
                    ${stock.currentPrice > 0 ? fmt(dailyTotal) : '...'}
                  </div>
                  <div class="metric-pct ${stock.currentPrice > 0 ? (dailyPct >= 0 ? 'green' : 'red') : ''}">
                    ${stock.currentPrice > 0 ? pct(dailyPct) : ''}
                  </div>
                </div>
                
                <div class="breakdown">
                  <div class="breakdown-row">
                    <span class="breakdown-label">Capital</span>
                    <span class="breakdown-value">
                      <span class="${stock.currentPrice > 0 ? (dailyCapital >= 0 ? 'green' : 'red') : ''}">
                        ${stock.currentPrice > 0 ? fmt(dailyCapital) : '$0.00'}
                      </span>
                      <span class="breakdown-pct ${stock.currentPrice > 0 ? (dailyCapital >= 0 ? 'green' : 'red') : ''}">
                        ${stock.currentPrice > 0 && prevValue > 0 ? pct((dailyCapital / prevValue) * 100) : ''}
                      </span>
                    </span>
                  </div>
                  
                  <div class="breakdown-row">
                    <span class="breakdown-label">Cash</span>
                    <span class="breakdown-value blue">
                      <span>${fmt(dailyCash)}</span>
                      <span class="breakdown-pct">
                        ${stock.currentPrice > 0 && prevValue > 0 && dailyCash !== 0 ? pct((dailyCash / prevValue) * 100) : ''}
                      </span>
                    </span>
                  </div>
                  
                  <div class="sub-breakdown">
                    <div class="breakdown-row">
                      <span class="breakdown-label">Dividends</span>
                      <span class="breakdown-value blue">
                        <span>${fmt(todayDivs.todayDiv)}</span>
                        <span class="breakdown-pct">
                          ${stock.currentPrice > 0 && prevValue > 0 && todayDivs.todayDiv !== 0 ? pct((todayDivs.todayDiv / prevValue) * 100) : ''}
                        </span>
                      </span>
                    </div>
                    <div class="breakdown-row">
                      <span class="breakdown-label">Franking</span>
                      <span class="breakdown-value blue">
                        <span>${fmt(todayDivs.todayFranking)}</span>
                        <span class="breakdown-pct">
                          ${stock.currentPrice > 0 && prevValue > 0 && todayDivs.todayFranking !== 0 ? pct((todayDivs.todayFranking / prevValue) * 100) : ''}
                        </span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="column">
                <div class="column-title">Life-to-date</div>
                
                <div class="metric">
                  <div class="metric-label">Change</div>
                  <div class="metric-value ${stock.currentPrice > 0 ? (ltdTotal >= 0 ? 'green' : 'red') : ''}">
                    ${stock.currentPrice > 0 ? fmt(ltdTotal) : '...'}
                  </div>
                  <div class="metric-pct ${stock.currentPrice > 0 ? (ltdPct >= 0 ? 'green' : 'red') : ''}">
                    ${stock.currentPrice > 0 ? pct(ltdPct) : ''}
                  </div>
                </div>
                
                <div class="breakdown">
                  <div class="breakdown-row">
                    <span class="breakdown-label">Capital</span>
                    <span class="breakdown-value">
                      <span class="${stock.currentPrice > 0 ? (ltdCapital >= 0 ? 'green' : 'red') : ''}">
                        ${stock.currentPrice > 0 ? fmt(ltdCapital) : '$0.00'}
                      </span>
                      <span class="breakdown-pct ${stock.currentPrice > 0 ? (ltdCapital >= 0 ? 'green' : 'red') : ''}">
                        ${stock.currentPrice > 0 && cost > 0 ? pct((ltdCapital / cost) * 100) : ''}
                      </span>
                    </span>
                  </div>
                  
                  <div class="breakdown-row">
                    <span class="breakdown-label">Cash</span>
                    <span class="breakdown-value blue">
                      <span>${fmt(ltdCash)}</span>
                      <span class="breakdown-pct">
                        ${cost > 0 && ltdCash !== 0 ? pct((ltdCash / cost) * 100) : ''}
                      </span>
                    </span>
                  </div>
                  
                  <div class="sub-breakdown">
                    <div class="breakdown-row">
                      <span class="breakdown-label">Dividends</span>
                      <span class="breakdown-value blue">
                        <span>${fmt(divs.totalDiv)}</span>
                        <span class="breakdown-pct">
                          ${cost > 0 && divs.totalDiv !== 0 ? pct((divs.totalDiv / cost) * 100) : ''}
                        </span>
                      </span>
                    </div>
                    <div class="breakdown-row">
                      <span class="breakdown-label">Franking</span>
                      <span class="breakdown-value blue">
                        <span>${fmt(divs.totalFranking)}</span>
                        <span class="breakdown-pct">
                          ${cost > 0 && divs.totalFranking !== 0 ? pct((divs.totalFranking / cost) * 100) : ''}
                        </span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            ${stockDivs.length > 0 ? `
              <div class="dividend-list">
                ${stockDivs.map((d, idx) => `
                  <div class="dividend-item">
                    <span class="dividend-date">${d.date}</span>
                    <span>$${d.amount.toFixed(4)}</span>
                    <span class="dividend-franking" onclick="editDividendFranking('${stock.code}', ${idx})">${d.franking}% franked</span>
                  </div>
                `).join('')}
              </div>
            ` : ''}
            
            <div class="stock-actions">
              <button class="btn-edit" onclick="openEditModal(${i})">Edit</button>
              <button class="btn-delete" onclick="deleteStock(${i})">Delete</button>
            </div>
          </div>
        `;
      }
      
      document.getElementById('stocks').innerHTML = html;
    }

    /* ==========================================
       INITIALIZATION
       ========================================== */

    window.addEventListener('load', () => {
      loadData();
      render();
      updateMarketStatus();
      
      // Auto-migration: Detect stale/bad data (AGGRESSIVE)
      let needsRefresh = false;
      
      if (portfolio.length > 0) {
        // Check 1: Any stock has zero prices
        const hasZeroPrices = portfolio.some(s => s.currentPrice === 0);
        
        // Check 2: Any stock missing prevClose
        const hasMissingPrevClose = portfolio.some(s => !s.prevClose || s.prevClose === 0);
        
        // Check 3: Index has suspicious gap (>50 points instead of 200)
        const indexLargeGap = indexData.prevClose > 0 && indexData.currentPrice > 0 &&
          Math.abs(indexData.currentPrice - indexData.prevClose) > 50;
        
        // Check 4: Index prevClose outside reasonable range
        const indexOutOfRange = indexData.prevClose > 0 && 
          (indexData.prevClose < 8000 || indexData.prevClose > 10000);
        
        // Check 5: Any stock has suspicious daily change (>10%)
        const stockLargeMove = portfolio.some(s => {
          if (s.currentPrice > 0 && s.prevClose > 0) {
            const change = Math.abs((s.currentPrice - s.prevClose) / s.prevClose);
            return change > 0.10; // 10% daily move is suspicious
          }
          return false;
        });
        
        needsRefresh = hasZeroPrices || hasMissingPrevClose || indexLargeGap || 
                       indexOutOfRange || stockLargeMove;
        
        if (needsRefresh) {
          console.log('Auto-migration triggers:', {
            hasZeroPrices,
            hasMissingPrevClose,
            indexLargeGap,
            indexOutOfRange,
            stockLargeMove,
            indexGap: Math.abs(indexData.currentPrice - indexData.prevClose)
          });
        }
      }
      
      // Auto-refresh if needed and market is open
      if (needsRefresh && isMarketOpen()) {
        console.log('Auto-migration: Refreshing with new parsing logic...');
        setTimeout(() => {
          updatePrices();
        }, 1000);
      } else if (needsRefresh && !isMarketOpen()) {
        console.log('Auto-migration: Stale data detected, but market is closed. Will auto-fix when market opens.');
      }
      
      // Update market status every minute
      setInterval(updateMarketStatus, 60000);
    });
  </script>
</body>
</html>
